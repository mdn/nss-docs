<h1>sample2</h1><div><div class="summary">
</div>

<pre class="brush: cpp notranslate"><code><span class="token comment">/* This Source Code Form is subject to the terms of the Mozilla Public * License, v. 2.0. If a copy of the MPL was not distributed with this * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span> <span class="token comment">/* NSPR Headers */</span> #include <span class="token operator">&lt;</span>prthread<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>plgetopt<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>prerror<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>prinit<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>prlog<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>prtypes<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>plstr<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token comment">/* NSS headers */</span> #include <span class="token operator">&lt;</span>cryptohi<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>keyhi<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>pk11priv<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>cert<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>base64<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>secerr<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>secport<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>secoid<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>secmodt<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>secoidt<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> #include <span class="token operator">&lt;</span>sechash<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token comment">/* our samples utilities */</span> #include <span class="token string">"util.h"</span> <span class="token comment">/* Constants */</span> #define BLOCKSIZE <span class="token number">32</span> #define MODBLOCKSIZE <span class="token number">128</span> #define DEFAULT_KEY_BITS <span class="token number">1024</span> <span class="token comment">/* Header file Constants */</span> #define ENCKEY_HEADER <span class="token string">"-----BEGIN WRAPPED ENCKEY-----"</span> #define ENCKEY_TRAILER <span class="token string">"-----END WRAPPED ENCKEY-----"</span> #define MACKEY_HEADER <span class="token string">"-----BEGIN WRAPPED MACKEY-----"</span> #define MACKEY_TRAILER <span class="token string">"-----END WRAPPED MACKEY-----"</span> #define IV_HEADER <span class="token string">"-----BEGIN IV-----"</span> #define IV_TRAILER <span class="token string">"-----END IV-----"</span> #define MAC_HEADER <span class="token string">"-----BEGIN MAC-----"</span> #define MAC_TRAILER <span class="token string">"-----END MAC-----"</span> #define PAD_HEADER <span class="token string">"-----BEGIN PAD-----"</span> #define PAD_TRAILER <span class="token string">"-----END PAD-----"</span> #define LAB_HEADER <span class="token string">"-----BEGIN KEY LABEL-----"</span> #define LAB_TRAILER <span class="token string">"-----END KEY LABEL-----"</span> #define PUBKEY_HEADER <span class="token string">"-----BEGIN PUB KEY -----"</span> #define PUBKEY_TRAILER <span class="token string">"-----END PUB KEY -----"</span> #define NS_CERTREQ_HEADER <span class="token string">"-----BEGIN NEW CERTIFICATE REQUEST-----"</span> #define NS_CERTREQ_TRAILER <span class="token string">"-----END NEW CERTIFICATE REQUEST-----"</span> #define NS_CERT_ENC_HEADER <span class="token string">"-----BEGIN CERTIFICATE FOR ENCRYPTION-----"</span> #define NS_CERT_ENC_TRAILER <span class="token string">"-----END CERTIFICATE FOR ENCRYPTION-----"</span> #define NS_CERT_VFY_HEADER <span class="token string">"-----BEGIN CERTIFICATE FOR SIGNATURE VERIFICATION-----"</span> #define NS_CERT_VFY_TRAILER <span class="token string">"-----END CERTIFICATE FOR SIGNATURE VERIFICATION-----"</span> #define NS_SIG_HEADER <span class="token string">"-----BEGIN SIGNATURE-----"</span> #define NS_SIG_TRAILER <span class="token string">"-----END SIGNATURE-----"</span> #define NS_CERT_HEADER <span class="token string">"-----BEGIN CERTIFICATE-----"</span> #define NS_CERT_TRAILER <span class="token string">"-----END CERTIFICATE-----"</span> <span class="token comment">/* Missing publically from nss versions earlier than 3.13 */</span> #ifndef SEC_ERROR_BASE #define <span class="token function">SEC_ERROR_BASE</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0x2000</span><span class="token punctuation">)</span> <span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> SEC_ERROR_IO <span class="token operator">=</span> SEC_ERROR_BASE <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">,</span> SEC_ERROR_TOKEN_NOT_LOGGED_IN <span class="token operator">=</span> <span class="token punctuation">(</span>SEC_ERROR_BASE <span class="token operator">+</span> <span class="token number">155</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SEC_ERROR_END_OF_LIST <span class="token punctuation">}</span> SECErrorCodes<span class="token punctuation">;</span> #endif <span class="token comment">/* PORT_ErrorToString introduced in nss 3.13. On earlier versions of nss that * don't support error tables, PR_ErrorToString will return "Unknown code". */</span> #ifndef PORT_ErrorToString #define <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">PR_ErrorToString</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> PR_LANGUAGE_I_DEFAULT<span class="token punctuation">)</span> #endif <span class="token comment">/* sample 6 commands */</span> <span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> GENERATE_CSR<span class="token punctuation">,</span> ADD_CERT_TO_DB<span class="token punctuation">,</span> SAVE_CERT_TO_HEADER<span class="token punctuation">,</span> ENCRYPT<span class="token punctuation">,</span> DECRYPT<span class="token punctuation">,</span> SIGN<span class="token punctuation">,</span> VERIFY<span class="token punctuation">,</span> UNKNOWN <span class="token punctuation">}</span> CommandType<span class="token punctuation">;</span> <span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> SYMKEY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> MACKEY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> IV <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> MAC <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> PAD <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> PUBKEY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> LAB <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> CERTENC<span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> CERTVFY<span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> SIG <span class="token operator">=</span> <span class="token number">9</span> <span class="token punctuation">}</span> HeaderType<span class="token punctuation">;</span> <span class="token comment">/* * Print usage message and exit */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Usage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s %s %s %s %s %s %s %s %s\n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">" -&lt;g|a|h|e|ds|v&gt; -d &lt;dbdirpath&gt; "</span><span class="token punctuation">,</span> <span class="token string">"[-p &lt;dbpwd&gt; | -f &lt;dbpwdfile&gt;] [-z &lt;noisefilename&gt;] [-a &lt;\"\"&gt;]"</span><span class="token punctuation">,</span> <span class="token string">"-s &lt;subject&gt; -r &lt;csr&gt; | "</span><span class="token punctuation">,</span> <span class="token string">"-n &lt;nickname&gt; -t &lt;trust&gt; -c &lt;cert&gt; [ -r &lt;csr&gt; -u &lt;issuernickname&gt; [-x &lt;\"\"&gt;] -m &lt;serialnumber&gt; ] | "</span><span class="token punctuation">,</span> <span class="token string">"-n &lt;nickname&gt; -b &lt;headerfilename&gt; | "</span><span class="token punctuation">,</span> <span class="token string">"-b &lt;headerfilename&gt; -i &lt;ipfilename&gt; -e &lt;encryptfilename&gt; | "</span><span class="token punctuation">,</span> <span class="token string">"-b &lt;headerfilename&gt; -i &lt;ipfilename&gt; | "</span><span class="token punctuation">,</span> <span class="token string">"-b &lt;headerfilename&gt; -i &lt;ipfilename&gt; | "</span><span class="token punctuation">,</span> <span class="token string">"-b &lt;headerfilename&gt; -e &lt;encryptfilename&gt; -o &lt;opfilename&gt; \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"commands:\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n --for generating cert request (for CA also)\n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-G -s &lt;subject&gt; -r &lt;csr&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n --to input and store cert (for CA also)\n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-A -n &lt;nickname&gt; -t &lt;trust&gt; -c &lt;cert&gt; [ -r &lt;csr&gt; -u &lt;issuernickname&gt; [-x &lt;\"\"&gt;] -m &lt;serialnumber&gt; ]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n --to put cert in header\n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-H -n &lt;nickname&gt; -b &lt;headerfilename&gt; [-v &lt;\"\"&gt;]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n --to find public key from cert in header and encrypt\n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-E -b &lt;headerfilename&gt; -i &lt;ipfilename&gt; -e &lt;encryptfilename&gt; "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n --decrypt using corresponding private key \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-D -b &lt;headerfilename&gt; -e &lt;encryptfilename&gt; -o &lt;opfilename&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n --Sign using private key \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-S -b &lt;headerfilename&gt; -i &lt;infilename&gt; "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n --Verify using public key \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-V -b &lt;headerfilename&gt; -i &lt;ipfilename&gt; "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"options:\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - db directory path\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-d &lt;dbdirpath&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - db password [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-p &lt;dbpwd&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - db password file [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-f &lt;dbpwdfile&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - noise file name [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-z &lt;noisefilename&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - input file name\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-i &lt;ipfilename&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - header file name\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-b &lt;headerfilename&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - encrypt file name\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-e &lt;encryptfilename&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - output file name\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-o &lt;opfilename&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - certificate serial number\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-m &lt;serialnumber&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - certificate nickname\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-n &lt;nickname&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - certificate trust\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-t &lt;trustargs&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - certificate issuer nickname\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-u &lt;issuernickname&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - certificate signing request \n\n"</span><span class="token punctuation">,</span> <span class="token string">"-r &lt;csr&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - generate a self-signed cert [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - to enable ascii [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-30s - to save certificate to header file as sig verification [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-v"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Validate the options used for Generate CSR command */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ValidateGenerateCSRCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> CERTName <span class="token operator">*</span>subject<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>subjectStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>certReqFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRBool validationFailed <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subject<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -G -d %s -s: improperly formatted name: \"%s\"\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> subjectStr<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>certReqFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -G -d %s -s %s -r: certificate request file name not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> subjectStr<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validationFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-G -d &lt;dbdirpath&gt; -s &lt;subject&gt; -r &lt;csr&gt; \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * Validate the options used for Add Cert to DB command */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ValidateAddCertToDBCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>trustStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>certFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>certReqFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>issuerNameStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>serialNumberStr<span class="token punctuation">,</span> PRBool selfsign<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRBool validationFailed <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nickNameStr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -A -d %s -n : nick name is missing\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trustStr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -A -d %s -n %s -t: trust flag is missing\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>certFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -A -d %s -n %s -t %s -c: certificate file name not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> trustStr<span class="token punctuation">,</span> serialNumberStr<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PR_Access</span><span class="token punctuation">(</span>certFileName<span class="token punctuation">,</span> PR_ACCESS_EXISTS<span class="token punctuation">)</span> <span class="token operator">==</span> PR_FAILURE<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>certReqFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -A -d %s -n %s -t %s -c %s -r: certificate file or certificate request file is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> trustStr<span class="token punctuation">,</span> certFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selfsign <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>issuerNameStr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -A -d %s -n %s -t %s -c %s -r %s -u : issuer name is missing\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> trustStr<span class="token punctuation">,</span> certFileName<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serialNumberStr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -A -d %s -n %s -t %s -c %s -r %s -u %s -m : serial number is missing\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> trustStr<span class="token punctuation">,</span> certFileName<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span> issuerNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validationFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">" -A -d &lt;dbdirpath&gt; -n &lt;nickname&gt; -t &lt;trust&gt; -c &lt;cert&gt; \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">" OR\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-A -d &lt;dbdirpath&gt; -n &lt;nickname&gt; -t &lt;trust&gt; -c &lt;cert&gt; -r &lt;csr&gt; -u &lt;issuernickname&gt; -m &lt;serialnumber&gt; [-x &lt;\"\"&gt;] \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * Validate the options used for Save Cert To Header command */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ValidateSaveCertToHeaderCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRBool validationFailed <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nickNameStr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -S -d %s -n : nick name is missing\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -S -d %s -n %s -b : header file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validationFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-S -d &lt;dbdirpath&gt; -n &lt;nickname&gt; -b &lt;headerfilename&gt; [-v &lt;\"\"&gt;]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * Validate the options used for Encrypt command */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ValidateEncryptCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRBool validationFailed <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nickNameStr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -E -d %s -n : nick name is missing\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -E -d %s -n %s -b : header file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -E -d %s -n %s -b %s -i : input file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encryptedFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -E -d %s -n %s -b %s -i %s -e : encrypt file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validationFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-E -d &lt;dbdirpath&gt; -b &lt;headerfilename&gt; -i &lt;ipfilename&gt; -e &lt;encryptfilename&gt; -n &lt;nickname&gt; \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * Validate the options used for Sign command */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ValidateSignCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRBool validationFailed <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nickNameStr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -I -d %s -n : nick name is missing\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -I -d %s -n %s -b : header file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -I -d %s -n %s -b %s -i : input file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validationFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-I -d &lt;dbdirpath&gt; -b &lt;headerfilename&gt; -i &lt;ipfilename&gt; -n &lt;nickname&gt; \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * Validate the options used for verify command */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ValidateVerifyCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRBool validationFailed <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -V -d %s -b : header file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -I -d %s -b %s -i : input file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validationFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-I -d &lt;dbdirpath&gt; -b &lt;headerfilename&gt; -i &lt;ipfilename&gt; \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * Validate the options used for Decrypt command */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ValidateDecryptCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>outFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRBool validationFailed <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -D -d %s -b : header file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encryptedFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -D -d %s -b %s -e : encrypt file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s -D -d %s -b %s -e %s -o : output file name is not found\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> validationFailed <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validationFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s %s \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">,</span> <span class="token string">"-D -d &lt;dbdirpath&gt; -b &lt;headerfilename&gt; -e &lt;encryptfilename&gt; -o &lt;opfilename&gt;\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * Sign the contents of input file using private key and * return result as SECItem */</span> SECStatus <span class="token function">SignData</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> SECKEYPrivateKey <span class="token operator">*</span>pk<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ibuf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>inFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SGNContext <span class="token operator">*</span>sgn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Open the input file for reading */</span> inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Sign using private key */</span> sgn <span class="token operator">=</span> <span class="token function">SGN_NewContext</span><span class="token punctuation">(</span>SEC_OID_PKCS1_MD5_WITH_RSA_ENCRYPTION<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sgn<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to create context for signing\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">SGN_Begin</span><span class="token punctuation">(</span>sgn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"problem while SGN_Begin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nb <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> ibuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ibuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">SGN_Update</span><span class="token punctuation">(</span>sgn<span class="token punctuation">,</span> ibuf<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"problem while SGN_Update\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">SGN_End</span><span class="token punctuation">(</span>sgn<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"problem while SGN_End\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>inFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sgn<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SGN_DestroyContext</span><span class="token punctuation">(</span>sgn<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Verify the signature using public key */</span> SECStatus <span class="token function">VerifyData</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> SECKEYPublicKey <span class="token operator">*</span>pk<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>sigItem<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nb<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ibuf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span> SECStatus rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> VFYContext <span class="token operator">*</span>vfy <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>inFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Open the input file for reading */</span> inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> vfy <span class="token operator">=</span> <span class="token function">VFY_CreateContext</span><span class="token punctuation">(</span>pk<span class="token punctuation">,</span> sigItem<span class="token punctuation">,</span> SEC_OID_PKCS1_MD5_WITH_RSA_ENCRYPTION<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vfy<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to create context for verifying signature\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">VFY_Begin</span><span class="token punctuation">(</span>vfy<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"problem while VFY_Begin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nb <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> ibuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ibuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">VFY_Update</span><span class="token punctuation">(</span>vfy<span class="token punctuation">,</span> ibuf<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"problem while VFY_Update\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">VFY_End</span><span class="token punctuation">(</span>vfy<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"problem while VFY_End\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>inFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vfy<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">VFY_DestroyContext</span><span class="token punctuation">(</span>vfy<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Write Cryptographic parameters to header file */</span> SECStatus <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> HeaderType type<span class="token punctuation">,</span> PRFileDesc <span class="token operator">*</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>header<span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>trailer<span class="token punctuation">;</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> SYMKEY<span class="token operator">:</span> header <span class="token operator">=</span> ENCKEY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> ENCKEY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MACKEY<span class="token operator">:</span> header <span class="token operator">=</span> MACKEY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> MACKEY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> IV<span class="token operator">:</span> header <span class="token operator">=</span> IV_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> IV_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MAC<span class="token operator">:</span> header <span class="token operator">=</span> MAC_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> MAC_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> PAD<span class="token operator">:</span> header <span class="token operator">=</span> PAD_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> PAD_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> PUBKEY<span class="token operator">:</span> header <span class="token operator">=</span> PUBKEY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> PUBKEY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> CERTENC<span class="token operator">:</span> header <span class="token operator">=</span> NS_CERT_ENC_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> NS_CERT_ENC_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> CERTVFY<span class="token operator">:</span> header <span class="token operator">=</span> NS_CERT_VFY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> NS_CERT_VFY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> SIG<span class="token operator">:</span> header <span class="token operator">=</span> NS_SIG_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> NS_SIG_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> LAB<span class="token operator">:</span> header <span class="token operator">=</span> LAB_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> LAB_TRAILER<span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n\n"</span><span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PrintAsHex</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n\n"</span><span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Read cryptographic parameters from the header file */</span> SECStatus <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fileName<span class="token punctuation">,</span> HeaderType type<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>item<span class="token punctuation">,</span> PRBool isHexData<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span> PRFileDesc<span class="token operator">*</span> file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem filedata<span class="token punctuation">;</span> SECItem outbuf<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>nonbody<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>body<span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>header<span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>trailer<span class="token punctuation">;</span> outbuf<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span> file <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to open %s\n"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> PUBKEY<span class="token operator">:</span> header <span class="token operator">=</span> PUBKEY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> PUBKEY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> SYMKEY<span class="token operator">:</span> header <span class="token operator">=</span> ENCKEY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> ENCKEY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MACKEY<span class="token operator">:</span> header <span class="token operator">=</span> MACKEY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> MACKEY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> IV<span class="token operator">:</span> header <span class="token operator">=</span> IV_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> IV_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MAC<span class="token operator">:</span> header <span class="token operator">=</span> MAC_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> MAC_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> PAD<span class="token operator">:</span> header <span class="token operator">=</span> PAD_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> PAD_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> LAB<span class="token operator">:</span> header <span class="token operator">=</span> LAB_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> LAB_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> CERTENC<span class="token operator">:</span> header <span class="token operator">=</span> NS_CERT_ENC_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> NS_CERT_ENC_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> CERTVFY<span class="token operator">:</span> header <span class="token operator">=</span> NS_CERT_VFY_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> NS_CERT_VFY_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> SIG<span class="token operator">:</span> header <span class="token operator">=</span> NS_SIG_HEADER<span class="token punctuation">;</span> trailer <span class="token operator">=</span> NS_SIG_TRAILER<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">default</span><span class="token operator">:</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">FileToItem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filedata<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span> nonbody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nonbody<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to read data from input file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* check for headers and trailers and remove them */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>body <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>nonbody<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">char</span> <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> nonbody <span class="token operator">=</span> body<span class="token punctuation">;</span> body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">)</span> body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>nonbody<span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* maybe this is a MAC file */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> trail <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token operator">++</span>body<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>trail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"input has header but no trailer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">/* headers didn't exist */</span> <span class="token keyword">char</span> <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> body <span class="token operator">=</span> nonbody<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span> trail <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token operator">++</span>body<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>trail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"input has no header but has trailer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token function">HexToBuf</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> item<span class="token punctuation">,</span> isHexData<span class="token punctuation">)</span><span class="token punctuation">;</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Generate the private key */</span> SECKEYPrivateKey <span class="token operator">*</span> <span class="token function">GeneratePrivateKey</span><span class="token punctuation">(</span>KeyType keytype<span class="token punctuation">,</span> PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> publicExponent<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>noise<span class="token punctuation">,</span> SECKEYPublicKey <span class="token operator">*</span><span class="token operator">*</span>pubkeyp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pqgFile<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">)</span> <span class="token punctuation">{</span> CK_MECHANISM_TYPE mechanism<span class="token punctuation">;</span> SECOidTag algtag<span class="token punctuation">;</span> PK11RSAGenParams rsaparams<span class="token punctuation">;</span> <span class="token keyword">void</span> <span class="token operator">*</span>params<span class="token punctuation">;</span> SECKEYPrivateKey <span class="token operator">*</span>privKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECStatus rv<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> randbuf<span class="token punctuation">[</span>BLOCKSIZE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">GenerateRandom</span><span class="token punctuation">(</span>randbuf<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error while generating the random numbers : %s\n"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PK11_RandomUpdate</span><span class="token punctuation">(</span>randbuf<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>keytype<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> rsaKey<span class="token operator">:</span> rsaparams<span class="token punctuation">.</span>keySizeInBits <span class="token operator">=</span> size<span class="token punctuation">;</span> rsaparams<span class="token punctuation">.</span>pe <span class="token operator">=</span> publicExponent<span class="token punctuation">;</span> mechanism <span class="token operator">=</span> CKM_RSA_PKCS_KEY_PAIR_GEN<span class="token punctuation">;</span> algtag <span class="token operator">=</span> SEC_OID_PKCS1_MD5_WITH_RSA_ENCRYPTION<span class="token punctuation">;</span> params <span class="token operator">=</span> <span class="token operator">&amp;</span>rsaparams<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Generating key. This may take a few moments...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> privKey <span class="token operator">=</span> <span class="token function">PK11_GenerateKeyPair</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> mechanism<span class="token punctuation">,</span> params<span class="token punctuation">,</span> pubkeyp<span class="token punctuation">,</span> PR_TRUE <span class="token comment">/*isPerm*/</span><span class="token punctuation">,</span> PR_TRUE <span class="token comment">/*isSensitive*/</span><span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> cleanup<span class="token operator">:</span> <span class="token keyword">return</span> privKey<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Get the certificate request from CSR */</span> <span class="token keyword">static</span> CERTCertificateRequest <span class="token operator">*</span> <span class="token function">GetCertRequest</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> CERTSignedData signedData<span class="token punctuation">;</span> SECItem reqDER<span class="token punctuation">;</span> CERTCertificateRequest <span class="token operator">*</span>certReq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECStatus rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span> PRArenaPool <span class="token operator">*</span>arena <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> reqDER<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> arena <span class="token operator">=</span> <span class="token function">PORT_NewArena</span><span class="token punctuation">(</span>DER_DEFAULT_CHUNKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arena <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">ReadDERFromFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reqDER<span class="token punctuation">,</span> inFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> certReq <span class="token operator">=</span> <span class="token punctuation">(</span>CERTCertificateRequest<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">PORT_ArenaZAlloc</span> <span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CERTCertificateRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>certReq<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> certReq<span class="token operator">-&gt;</span>arena <span class="token operator">=</span> arena<span class="token punctuation">;</span> <span class="token comment">/* Since cert request is a signed data, must decode to get the inner data */</span> <span class="token function">PORT_Memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>signedData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signedData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">SEC_ASN1DecodeItem</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token operator">&amp;</span>signedData<span class="token punctuation">,</span> <span class="token function">SEC_ASN1_GET</span><span class="token punctuation">(</span>CERT_SignedDataTemplate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>reqDER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">SEC_ASN1DecodeItem</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> certReq<span class="token punctuation">,</span> <span class="token function">SEC_ASN1_GET</span><span class="token punctuation">(</span>CERT_CertificateRequestTemplate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>signedData<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">CERT_VerifySignedDataWithPublicKeyInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>signedData<span class="token punctuation">,</span> <span class="token operator">&amp;</span>certReq<span class="token operator">-&gt;</span>subjectPublicKeyInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token comment">/* wincx */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reqDER<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reqDER<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"bad certificate request\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arena<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PORT_FreeArena</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> certReq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> certReq<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Sign Cert */</span> <span class="token keyword">static</span> SECItem <span class="token operator">*</span> <span class="token function">SignCert</span><span class="token punctuation">(</span>CERTCertDBHandle <span class="token operator">*</span>handle<span class="token punctuation">,</span> CERTCertificate <span class="token operator">*</span>cert<span class="token punctuation">,</span> PRBool selfsign<span class="token punctuation">,</span> SECOidTag hashAlgTag<span class="token punctuation">,</span> SECKEYPrivateKey <span class="token operator">*</span>privKey<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>issuerNickName<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pwarg<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECItem der<span class="token punctuation">;</span> SECStatus rv<span class="token punctuation">;</span> SECOidTag algID<span class="token punctuation">;</span> <span class="token keyword">void</span> <span class="token operator">*</span>dummy<span class="token punctuation">;</span> PRArenaPool <span class="token operator">*</span>arena <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECKEYPrivateKey <span class="token operator">*</span>caPrivateKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selfsign<span class="token punctuation">)</span> <span class="token punctuation">{</span> CERTCertificate <span class="token operator">*</span>issuer <span class="token operator">=</span> <span class="token function">PK11_FindCertFromNickname</span><span class="token punctuation">(</span>issuerNickName<span class="token punctuation">,</span> pwarg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CERTCertificate <span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span> <span class="token operator">==</span> issuer<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to find issuer with nickname %s\n"</span><span class="token punctuation">,</span> issuerNickName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> privKey <span class="token operator">=</span> caPrivateKey <span class="token operator">=</span> <span class="token function">PK11_FindKeyByAnyCert</span><span class="token punctuation">(</span>issuer<span class="token punctuation">,</span> pwarg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CERT_DestroyCertificate</span><span class="token punctuation">(</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>caPrivateKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to retrieve key %s\n"</span><span class="token punctuation">,</span> issuerNickName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> arena <span class="token operator">=</span> cert<span class="token operator">-&gt;</span>arena<span class="token punctuation">;</span> algID <span class="token operator">=</span> <span class="token function">SEC_GetSignatureAlgorithmOidTag</span><span class="token punctuation">(</span>privKey<span class="token operator">-&gt;</span>keyType<span class="token punctuation">,</span> hashAlgTag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>algID <span class="token operator">==</span> SEC_OID_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unknown key or hash type for issuer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">SECOID_SetAlgorithmID</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cert<span class="token operator">-&gt;</span>signature<span class="token punctuation">,</span> algID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not set signature algorithm id.\n%s\n"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* we only deal with cert v3 here */</span> <span class="token operator">*</span><span class="token punctuation">(</span>cert<span class="token operator">-&gt;</span>version<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> cert<span class="token operator">-&gt;</span>version<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> der<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> der<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> dummy <span class="token operator">=</span> <span class="token function">SEC_ASN1EncodeItem</span> <span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token operator">&amp;</span>der<span class="token punctuation">,</span> cert<span class="token punctuation">,</span> <span class="token function">SEC_ASN1_GET</span><span class="token punctuation">(</span>CERT_CertificateTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dummy<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not encode certificate.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> result <span class="token operator">=</span> <span class="token punctuation">(</span>SECItem <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">PORT_ArenaZAlloc</span> <span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>SECItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not allocate item for certificate data.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">SEC_DerSignData</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> result<span class="token punctuation">,</span> der<span class="token punctuation">.</span>data<span class="token punctuation">,</span> der<span class="token punctuation">.</span>len<span class="token punctuation">,</span> privKey<span class="token punctuation">,</span> algID<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not sign encoded certificate data : %s\n"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* result allocated out of the arena, it will be freed * when the arena is freed */</span> result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cert<span class="token operator">-&gt;</span>derCert <span class="token operator">=</span> <span class="token operator">*</span>result<span class="token punctuation">;</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>caPrivateKey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPrivateKey</span><span class="token punctuation">(</span>caPrivateKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * MakeV1Cert */</span> <span class="token keyword">static</span> CERTCertificate <span class="token operator">*</span> <span class="token function">MakeV1Cert</span><span class="token punctuation">(</span>CERTCertDBHandle <span class="token operator">*</span>handle<span class="token punctuation">,</span> CERTCertificateRequest <span class="token operator">*</span>req<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> issuerNickName<span class="token punctuation">,</span> PRBool selfsign<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> serialNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> warpmonths<span class="token punctuation">,</span> <span class="token keyword">int</span> validityMonths<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRExplodedTime printableTime<span class="token punctuation">;</span> PRTime now<span class="token punctuation">;</span> PRTime after<span class="token punctuation">;</span> CERTValidity <span class="token operator">*</span>validity <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>issuerCert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>selfsign <span class="token punctuation">)</span> <span class="token punctuation">{</span> issuerCert <span class="token operator">=</span> <span class="token function">CERT_FindCertByNicknameOrEmailAddr</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> issuerNickName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>issuerCert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not find certificate named %s\n"</span><span class="token punctuation">,</span> issuerNickName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> now <span class="token operator">=</span> <span class="token function">PR_Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_ExplodeTime</span> <span class="token punctuation">(</span>now<span class="token punctuation">,</span> PR_GMTParameters<span class="token punctuation">,</span> <span class="token operator">&amp;</span>printableTime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> warpmonths <span class="token punctuation">)</span> <span class="token punctuation">{</span> printableTime<span class="token punctuation">.</span>tm_month <span class="token operator">+=</span> warpmonths<span class="token punctuation">;</span> now <span class="token operator">=</span> <span class="token function">PR_ImplodeTime</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>printableTime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_ExplodeTime</span> <span class="token punctuation">(</span>now<span class="token punctuation">,</span> PR_GMTParameters<span class="token punctuation">,</span> <span class="token operator">&amp;</span>printableTime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> printableTime<span class="token punctuation">.</span>tm_month <span class="token operator">+=</span> validityMonths<span class="token punctuation">;</span> after <span class="token operator">=</span> <span class="token function">PR_ImplodeTime</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>printableTime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* note that the time is now in micro-second unit */</span> validity <span class="token operator">=</span> <span class="token function">CERT_CreateValidity</span> <span class="token punctuation">(</span>now<span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>validity<span class="token punctuation">)</span> <span class="token punctuation">{</span> cert <span class="token operator">=</span> <span class="token function">CERT_CreateCertificate</span><span class="token punctuation">(</span>serialNumber<span class="token punctuation">,</span> <span class="token punctuation">(</span>selfsign <span class="token operator">?</span> <span class="token operator">&amp;</span>req<span class="token operator">-&gt;</span>subject <span class="token operator">:</span> <span class="token operator">&amp;</span>issuerCert<span class="token operator">-&gt;</span>subject<span class="token punctuation">)</span><span class="token punctuation">,</span> validity<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CERT_DestroyValidity</span><span class="token punctuation">(</span>validity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> issuerCert <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span> <span class="token punctuation">(</span>issuerCert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> cert<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Add a certificate to the nss database */</span> SECStatus <span class="token function">AddCert</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> CERTCertDBHandle <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>trusts<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">,</span> PRBool emailcert<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pwdata<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECItem certDER<span class="token punctuation">;</span> SECStatus rv<span class="token punctuation">;</span> CERTCertTrust <span class="token operator">*</span>trust <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> certDER<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Read in the entire file specified with the -i argument */</span> rv <span class="token operator">=</span> <span class="token function">ReadDERFromFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>certDER<span class="token punctuation">,</span> inFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to read input file %s : %s\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read in an ASCII cert and return a CERTCertificate */</span> cert <span class="token operator">=</span> <span class="token function">CERT_DecodeCertFromPackage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>certDER<span class="token punctuation">.</span>data<span class="token punctuation">,</span> certDER<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not obtain certificate from file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Create a cert trust */</span> trust <span class="token operator">=</span> <span class="token punctuation">(</span>CERTCertTrust <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PORT_ZAlloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>CERTCertTrust<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trust<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to allocate cert trust\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">CERT_DecodeTrustString</span><span class="token punctuation">(</span>trust<span class="token punctuation">,</span> trusts<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to decode trust string\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">PK11_ImportCert</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> cert<span class="token punctuation">,</span> CK_INVALID_HANDLE<span class="token punctuation">,</span> name<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* sigh, PK11_Import Cert and CERT_ChangeCertTrust should have * been coded to take a password arg. */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PORT_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SEC_ERROR_TOKEN_NOT_LOGGED_IN<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not authenticate to token %s : %s\n"</span><span class="token punctuation">,</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">PK11_ImportCert</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> cert<span class="token punctuation">,</span> CK_INVALID_HANDLE<span class="token punctuation">,</span> name<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not add certificate to token or database : %s\n"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">CERT_ChangeCertTrust</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> cert<span class="token punctuation">,</span> trust<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PORT_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SEC_ERROR_TOKEN_NOT_LOGGED_IN<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not authenticate to token %s : %s\n"</span><span class="token punctuation">,</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">CERT_ChangeCertTrust</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> cert<span class="token punctuation">,</span> trust<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not change trust on certificate : %s\n"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>emailcert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_SaveSMimeProfile</span><span class="token punctuation">(</span>cert<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span> <span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>trust<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PORT_Free</span><span class="token punctuation">(</span>trust<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>certDER<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PORT_Free</span><span class="token punctuation">(</span>certDER<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Create a certificate */</span> <span class="token keyword">static</span> SECStatus <span class="token function">CreateCert</span><span class="token punctuation">(</span> CERTCertDBHandle <span class="token operator">*</span>handle<span class="token punctuation">,</span> PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> issuerNickName<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>outFileName<span class="token punctuation">,</span> SECKEYPrivateKey <span class="token operator">*</span><span class="token operator">*</span>selfsignprivkey<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pwarg<span class="token punctuation">,</span> SECOidTag hashAlgTag<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> serialNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> warpmonths<span class="token punctuation">,</span> <span class="token keyword">int</span> validityMonths<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dnsNames<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">,</span> PRBool selfsign<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">void</span> <span class="token operator">*</span>extHandle<span class="token punctuation">;</span> SECItem reqDER<span class="token punctuation">;</span> CERTCertExtension <span class="token operator">*</span><span class="token operator">*</span>CRexts<span class="token punctuation">;</span> SECStatus rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>subjectCert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificateRequest <span class="token operator">*</span>certReq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>outFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem <span class="token operator">*</span>certDER <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> reqDER<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> outFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>outFileName<span class="token punctuation">,</span> PR_RDWR <span class="token operator">|</span> PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Create a cert request object from the input cert request der */</span> certReq <span class="token operator">=</span> <span class="token function">GetCertRequest</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>certReq <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> subjectCert <span class="token operator">=</span> <span class="token function">MakeV1Cert</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> certReq<span class="token punctuation">,</span> issuerNickName<span class="token punctuation">,</span> selfsign<span class="token punctuation">,</span> serialNumber<span class="token punctuation">,</span> warpmonths<span class="token punctuation">,</span> validityMonths<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>subjectCert <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> extHandle <span class="token operator">=</span> <span class="token function">CERT_StartCertExtensions</span> <span class="token punctuation">(</span>subjectCert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>extHandle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>certReq<span class="token operator">-&gt;</span>attributes <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> certReq<span class="token operator">-&gt;</span>attributes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> certReq<span class="token operator">-&gt;</span>attributes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>attrType<span class="token punctuation">.</span>data <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> certReq<span class="token operator">-&gt;</span>attributes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>attrType<span class="token punctuation">.</span>len <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">SECOID_FindOIDTag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>certReq<span class="token operator">-&gt;</span>attributes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>attrType<span class="token punctuation">)</span> <span class="token operator">==</span> SEC_OID_PKCS9_EXTENSION_REQUEST<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">CERT_GetCertificateRequestExtensions</span><span class="token punctuation">(</span>certReq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CRexts<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">CERT_MergeExtensions</span><span class="token punctuation">(</span>extHandle<span class="token punctuation">,</span> CRexts<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token function">CERT_FinishExtensions</span><span class="token punctuation">(</span>extHandle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* self-signing a cert request, find the private key */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>selfsignprivkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>selfsignprivkey <span class="token operator">=</span> <span class="token function">PK11_FindKeyByDERCert</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> subjectCert<span class="token punctuation">,</span> pwarg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>selfsignprivkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to locate private key.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> certDER <span class="token operator">=</span> <span class="token function">SignCert</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> subjectCert<span class="token punctuation">,</span> selfsign<span class="token punctuation">,</span> hashAlgTag<span class="token punctuation">,</span> <span class="token operator">*</span>selfsignprivkey<span class="token punctuation">,</span> issuerNickName<span class="token punctuation">,</span>pwarg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>certDER<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n%s\n%s\n"</span><span class="token punctuation">,</span> NS_CERT_HEADER<span class="token punctuation">,</span> <span class="token function">BTOA_DataToAscii</span><span class="token punctuation">(</span>certDER<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> certDER<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> NS_CERT_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> certDER<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> certDER<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> PRErrorCode perr <span class="token operator">=</span> <span class="token function">PR_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to create cert %s\n"</span><span class="token punctuation">,</span> perr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>selfsignprivkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPrivateKey</span><span class="token punctuation">(</span><span class="token operator">*</span>selfsignprivkey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>certReq<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificateRequest</span><span class="token punctuation">(</span>certReq<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>subjectCert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span><span class="token punctuation">(</span>subjectCert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Generate the certificate request with subject */</span> <span class="token keyword">static</span> SECStatus <span class="token function">CertReq</span><span class="token punctuation">(</span>SECKEYPrivateKey <span class="token operator">*</span>privk<span class="token punctuation">,</span> SECKEYPublicKey <span class="token operator">*</span>pubk<span class="token punctuation">,</span> KeyType keyType<span class="token punctuation">,</span> SECOidTag hashAlgTag<span class="token punctuation">,</span> CERTName <span class="token operator">*</span>subject<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>certReqFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECOidTag signAlgTag<span class="token punctuation">;</span> SECItem result<span class="token punctuation">;</span> PRInt32 numBytes<span class="token punctuation">;</span> SECStatus rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span> PRArenaPool <span class="token operator">*</span>arena <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">void</span> <span class="token operator">*</span>extHandle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>outFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTSubjectPublicKeyInfo <span class="token operator">*</span>spki <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificateRequest <span class="token operator">*</span>cr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem <span class="token operator">*</span>encoding <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* If the certificate request file already exists, delete it */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PR_Access</span><span class="token punctuation">(</span>certReqFileName<span class="token punctuation">,</span> PR_ACCESS_EXISTS<span class="token punctuation">)</span> <span class="token operator">==</span> PR_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Delete</span><span class="token punctuation">(</span>certReqFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the certificate request file to write */</span> outFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>certReqFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_RDWR <span class="token operator">|</span> PR_TRUNCATE<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to open \"%s\" for writing (%ld, %ld).\n"</span><span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span> <span class="token function">PR_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PR_GetOSError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Create info about public key */</span> spki <span class="token operator">=</span> <span class="token function">SECKEY_CreateSubjectPublicKeyInfo</span><span class="token punctuation">(</span>pubk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spki<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to create subject public key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Generate certificate request */</span> cr <span class="token operator">=</span> <span class="token function">CERT_CreateCertificateRequest</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> spki<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to make certificate request\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> arena <span class="token operator">=</span> <span class="token function">PORT_NewArena</span><span class="token punctuation">(</span>DER_DEFAULT_CHUNKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arena<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"out of memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> extHandle <span class="token operator">=</span> <span class="token function">CERT_StartCertificateRequestAttributes</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>extHandle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PORT_FreeArena</span> <span class="token punctuation">(</span>arena<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">CERT_FinishExtensions</span><span class="token punctuation">(</span>extHandle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CERT_FinishCertificateRequestAttributes</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Der encode the request */</span> encoding <span class="token operator">=</span> <span class="token function">SEC_ASN1EncodeItem</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> cr<span class="token punctuation">,</span> <span class="token function">SEC_ASN1_GET</span><span class="token punctuation">(</span>CERT_CertificateRequestTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"der encoding of request failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Sign the request */</span> signAlgTag <span class="token operator">=</span> <span class="token function">SEC_GetSignatureAlgorithmOidTag</span><span class="token punctuation">(</span>keyType<span class="token punctuation">,</span> hashAlgTag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>signAlgTag <span class="token operator">==</span> SEC_OID_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unknown Key or Hash type\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">SEC_DerSignData</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">,</span> encoding<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> encoding<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span> privk<span class="token punctuation">,</span> signAlgTag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"signing of data failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Encode request in specified format */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">char</span> <span class="token operator">*</span>obuf<span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token operator">*</span>email<span class="token punctuation">,</span> <span class="token operator">*</span>org<span class="token punctuation">,</span> <span class="token operator">*</span>state<span class="token punctuation">,</span> <span class="token operator">*</span>country<span class="token punctuation">;</span> SECItem <span class="token operator">*</span>it<span class="token punctuation">;</span> <span class="token keyword">int</span> total<span class="token punctuation">;</span> it <span class="token operator">=</span> <span class="token operator">&amp;</span>result<span class="token punctuation">;</span> obuf <span class="token operator">=</span> <span class="token function">BTOA_ConvertItemToAscii</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span> total <span class="token operator">=</span> <span class="token function">PL_strlen</span><span class="token punctuation">(</span>obuf<span class="token punctuation">)</span><span class="token punctuation">;</span> name <span class="token operator">=</span> <span class="token function">CERT_GetCommonName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> email <span class="token operator">=</span> <span class="token function">CERT_GetCertEmailAddress</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span> email <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> org <span class="token operator">=</span> <span class="token function">CERT_GetOrgName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>org<span class="token punctuation">)</span> org <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> state <span class="token operator">=</span> <span class="token function">CERT_GetStateName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span> state <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> country <span class="token operator">=</span> <span class="token function">CERT_GetCountryName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>country<span class="token punctuation">)</span> country <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"\nCertificate request generated by Netscape certutil\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Common Name: %s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Email: %s\n"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Organization: %s\n"</span><span class="token punctuation">,</span> org<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"State: %s\n"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Country: %s\n\n"</span><span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> NS_CERTREQ_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> numBytes <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> obuf<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"write error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"\n%s\n"</span><span class="token punctuation">,</span> NS_CERTREQ_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> numBytes <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> result<span class="token punctuation">.</span>data<span class="token punctuation">,</span> result<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result<span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"write error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>privk<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPrivateKey</span><span class="token punctuation">(</span>privk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pubk<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPublicKey</span><span class="token punctuation">(</span>pubk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Create certificate request with subject */</span> SECStatus <span class="token function">CreateCertRequest</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> CERTName <span class="token operator">*</span>subject<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>certReqFileName<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> SECKEYPrivateKey <span class="token operator">*</span>privkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECKEYPublicKey <span class="token operator">*</span>pubkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> KeyType keytype <span class="token operator">=</span> rsaKey<span class="token punctuation">;</span> <span class="token keyword">int</span> keysize <span class="token operator">=</span> DEFAULT_KEY_BITS<span class="token punctuation">;</span> <span class="token keyword">int</span> publicExponent <span class="token operator">=</span> <span class="token number">0x010001</span><span class="token punctuation">;</span> SECOidTag hashAlgTag <span class="token operator">=</span> SEC_OID_UNKNOWN<span class="token punctuation">;</span> privkey <span class="token operator">=</span> <span class="token function">GeneratePrivateKey</span><span class="token punctuation">(</span>keytype<span class="token punctuation">,</span> slot<span class="token punctuation">,</span> keysize<span class="token punctuation">,</span> publicExponent<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pubkey<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>privkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to generate key(s)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> privkey<span class="token operator">-&gt;</span>wincx <span class="token operator">=</span> pwdata<span class="token punctuation">;</span> <span class="token function">PORT_Assert</span><span class="token punctuation">(</span>pubkey <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">CertReq</span><span class="token punctuation">(</span>privkey<span class="token punctuation">,</span> pubkey<span class="token punctuation">,</span> keytype<span class="token punctuation">,</span> hashAlgTag<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> ascii<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to create Certificate Request\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Creates the certificate using CSR and adds the certificate to DB */</span> SECStatus <span class="token function">AddCertificateToDB</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>certReqFileName<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>certFileName<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>issuerNameStr<span class="token punctuation">,</span> CERTCertDBHandle <span class="token operator">*</span>certHandle<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>trustStr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> serialNumber<span class="token punctuation">,</span> PRBool selfsign<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> SECKEYPrivateKey <span class="token operator">*</span>privkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECKEYPublicKey <span class="token operator">*</span>pubkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECOidTag hashAlgTag <span class="token operator">=</span> SEC_OID_UNKNOWN<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PR_Access</span><span class="token punctuation">(</span>certFileName<span class="token punctuation">,</span> PR_ACCESS_EXISTS<span class="token punctuation">)</span> <span class="token operator">==</span> PR_FAILURE<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">CreateCert</span><span class="token punctuation">(</span>certHandle<span class="token punctuation">,</span> slot<span class="token punctuation">,</span> issuerNameStr<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span> certFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>privkey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> hashAlgTag<span class="token punctuation">,</span> serialNumber<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> ascii<span class="token punctuation">,</span> selfsign<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to create Certificate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">AddCert</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> certHandle<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> trustStr<span class="token punctuation">,</span> certFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to add Certificate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Finds the certificate using nickname and saves it to the header file */</span> SECStatus <span class="token function">AddCertificateToHeader</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> CERTCertDBHandle <span class="token operator">*</span>certHandle<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr<span class="token punctuation">,</span> PRBool sigVerify<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>headerFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> HeaderType hType <span class="token operator">=</span> CERTENC<span class="token punctuation">;</span> <span class="token comment">/* If the intermediate header file already exists, delete it */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PR_Access</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PR_ACCESS_EXISTS<span class="token punctuation">)</span> <span class="token operator">==</span> PR_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Delete</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> headerFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_RDWR <span class="token operator">|</span> PR_TRUNCATE<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to open \"%s\" for writing (%ld, %ld).\n"</span><span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> <span class="token function">PR_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PR_GetOSError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cert <span class="token operator">=</span> <span class="token function">CERT_FindCertByNicknameOrEmailAddr</span><span class="token punctuation">(</span>certHandle<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not obtain certificate from file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sigVerify<span class="token punctuation">)</span> <span class="token punctuation">{</span> hType <span class="token operator">=</span> CERTVFY<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>cert<span class="token operator">-&gt;</span>derCert<span class="token punctuation">.</span>data<span class="token punctuation">,</span> cert<span class="token operator">-&gt;</span>derCert<span class="token punctuation">.</span>len<span class="token punctuation">,</span> hType<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Finds the public key from the certificate saved in the header file * and encrypts with it the contents of inFileName to encryptedFileName. */</span> SECStatus <span class="token function">FindKeyAndEncrypt</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>headerFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>encFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>inFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem data<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ptext<span class="token punctuation">[</span>MODBLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> encBuf<span class="token punctuation">[</span>MODBLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ptextLen<span class="token punctuation">;</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nWritten<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> SECItem padItem<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> paddingLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> SECKEYPublicKey <span class="token operator">*</span>pubkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* If the intermediate encrypted file already exists, delete it*/</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PR_Access</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> PR_ACCESS_EXISTS<span class="token punctuation">)</span> <span class="token operator">==</span> PR_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Delete</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read certificate from header file */</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> CERTENC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not read certificate from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read in an ASCII cert and return a CERTCertificate */</span> cert <span class="token operator">=</span> <span class="token function">CERT_DecodeCertFromPackage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">.</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not obtain certificate from file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Extract the public key from certificate */</span> pubkey <span class="token operator">=</span> <span class="token function">CERT_ExtractPublicKey</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pubkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not get key from certificate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the encrypted file for writing */</span> encFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the input file for reading */</span> inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the header file to write padding */</span> headerFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_RDWR <span class="token operator">|</span> PR_APPEND<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read input file */</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptextLen <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ptext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptextLen <span class="token operator">!=</span> MODBLOCKSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span> paddingLength <span class="token operator">=</span> MODBLOCKSIZE <span class="token operator">-</span> ptextLen<span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token punctuation">(</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> paddingLength<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ptext<span class="token punctuation">[</span>ptextLen<span class="token operator">+</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>paddingLength<span class="token punctuation">;</span> <span class="token punctuation">}</span> ptextLen <span class="token operator">=</span> MODBLOCKSIZE<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">PK11_PubEncryptRaw</span><span class="token punctuation">(</span>pubkey<span class="token punctuation">,</span> encBuf<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> ptextLen<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nWritten <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>encFile<span class="token punctuation">,</span> encBuf<span class="token punctuation">,</span> ptextLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Write the padding to header file */</span> pad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> paddingLength<span class="token punctuation">;</span> padItem<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span> padItem<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pad<span class="token punctuation">;</span> padItem<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>padItem<span class="token punctuation">.</span>data<span class="token punctuation">,</span> padItem<span class="token punctuation">.</span>len<span class="token punctuation">,</span> PAD<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>encFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>inFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPublicKey</span><span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Finds the private key from db and signs the contents * of inFileName and writes to signatureFileName */</span> SECStatus <span class="token function">FindKeyAndSign</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> CERTCertDBHandle<span class="token operator">*</span> certHandle<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>headerFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>inFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> signatureLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> SECKEYPrivateKey <span class="token operator">*</span>privkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem sigItem<span class="token punctuation">;</span> SECOidTag hashOIDTag<span class="token punctuation">;</span> <span class="token comment">/* Open the header file to write padding */</span> headerFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_RDWR <span class="token operator">|</span> PR_APPEND<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Get the certificate by nick name and write to header file */</span> cert <span class="token operator">=</span> <span class="token function">CERT_FindCertByNicknameOrEmailAddr</span><span class="token punctuation">(</span>certHandle<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not obtain certificate by name - %s\n"</span><span class="token punctuation">,</span> nickNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>cert<span class="token operator">-&gt;</span>derCert<span class="token punctuation">.</span>data<span class="token punctuation">,</span> cert<span class="token operator">-&gt;</span>derCert<span class="token punctuation">.</span>len<span class="token punctuation">,</span> CERTVFY<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Find private key from certificate */</span> privkey <span class="token operator">=</span> <span class="token function">PK11_FindKeyByAnyCert</span><span class="token punctuation">(</span>cert<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>privkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't find private key for cert\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Sign the contents of the input file */</span> rv <span class="token operator">=</span> <span class="token function">SignData</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> privkey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sigItem<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not sign the contents from file - %s \n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* write signature to header file */</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>sigItem<span class="token punctuation">.</span>data<span class="token punctuation">,</span> sigItem<span class="token punctuation">.</span>len<span class="token punctuation">,</span> SIG<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>privkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPrivateKey</span><span class="token punctuation">(</span>privkey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Finds the public key from certificate and verifies signature */</span> SECStatus <span class="token function">FindKeyAndVerify</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> CERTCertDBHandle<span class="token operator">*</span> certHandle<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>headerFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>inFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECKEYPublicKey <span class="token operator">*</span>pubkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem sigItem<span class="token punctuation">;</span> SECItem certData<span class="token punctuation">;</span> <span class="token comment">/* Open the input file */</span> inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the header file to read the certificate and signature */</span> headerFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read certificate from header file */</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> CERTVFY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>certData<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not read certificate from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read in an ASCII cert and return a CERTCertificate */</span> cert <span class="token operator">=</span> <span class="token function">CERT_DecodeCertFromPackage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>certData<span class="token punctuation">.</span>data<span class="token punctuation">,</span> certData<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not obtain certificate from file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Extract the public key from certificate */</span> pubkey <span class="token operator">=</span> <span class="token function">CERT_ExtractPublicKey</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pubkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not get key from certificate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read signature from header file */</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> SIG<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sigItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not read signature from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Verify with the public key */</span> rv <span class="token operator">=</span> <span class="token function">VerifyData</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> pubkey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sigItem<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Couldn't verify the signature for file - %s\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPublicKey</span><span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Finds the private key corresponding to the certificate saved in the header file * and decrypts with it the contents of encryptedFileName to outFileName. */</span> SECStatus <span class="token function">FindKeyAndDecrypt</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>outFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>encFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>outFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECKEYPrivateKey <span class="token operator">*</span>pvtkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inFileLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> paddingLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ctext<span class="token punctuation">[</span>MODBLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> decBuf<span class="token punctuation">[</span>MODBLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ctextLen<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> decBufLen<span class="token punctuation">;</span> SECItem padItem<span class="token punctuation">;</span> SECItem data<span class="token punctuation">;</span> SECItem signature<span class="token punctuation">;</span> CERTCertificate <span class="token operator">*</span>cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Read certificate from header file */</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> CERTENC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not read certificate from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read padding from header file */</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PAD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>padItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not retrieve PAD detail from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> paddingLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>padItem<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> inFileLength <span class="token operator">=</span> <span class="token function">FileSize</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Read in an ASCII cert and return a CERTCertificate */</span> cert <span class="token operator">=</span> <span class="token function">CERT_DecodeCertFromPackage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">.</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"could not obtain certificate from file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Find private key from certificate */</span> pvtkey <span class="token operator">=</span> <span class="token function">PK11_FindKeyByAnyCert</span><span class="token punctuation">(</span>cert<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pvtkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't find private key for cert\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the out file to write */</span> outFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>outFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> outFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the encrypted file for reading */</span> encFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read the encrypt file, decrypt and write to out file */</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ctextLen <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>encFile<span class="token punctuation">,</span> ctext<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ctext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> count <span class="token operator">+=</span> ctextLen<span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">PK11_PubDecryptRaw</span><span class="token punctuation">(</span>pvtkey<span class="token punctuation">,</span> decBuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>decBufLen<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>decBuf<span class="token punctuation">)</span><span class="token punctuation">,</span> ctext<span class="token punctuation">,</span> ctextLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't decrypt\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>decBufLen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> inFileLength<span class="token punctuation">)</span> <span class="token punctuation">{</span> decBufLen <span class="token operator">=</span> decBufLen <span class="token operator">-</span> paddingLength<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* write the plain text to out file */</span> temp <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> decBuf<span class="token punctuation">,</span> decBufLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">!=</span> decBufLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"write error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>encFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pvtkey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECKEY_DestroyPrivateKey</span><span class="token punctuation">(</span>pvtkey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cert<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CERT_DestroyCertificate</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Map option letter to command */</span> <span class="token keyword">static</span> CommandType <span class="token function">option2Command</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token string">'G'</span><span class="token operator">:</span> <span class="token keyword">return</span> GENERATE_CSR<span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'A'</span><span class="token operator">:</span> <span class="token keyword">return</span> ADD_CERT_TO_DB<span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'H'</span><span class="token operator">:</span> <span class="token keyword">return</span> SAVE_CERT_TO_HEADER<span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'E'</span><span class="token operator">:</span> <span class="token keyword">return</span> ENCRYPT<span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'D'</span><span class="token operator">:</span> <span class="token keyword">return</span> DECRYPT<span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'S'</span><span class="token operator">:</span> <span class="token keyword">return</span> SIGN<span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'V'</span><span class="token operator">:</span> <span class="token keyword">return</span> VERIFY<span class="token punctuation">;</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> UNKNOWN<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* * This example illustrates basic encryption/decryption and MACing * Generates the RSA key pair as token object and outputs public key as cert request. * Reads cert request file and stores certificate in DB. * Input, store and trust CA certificate. * Write certificate to intermediate header file * Extract public key from certificate, encrypts the input file and write to external file. * Finds the matching private key, decrypts and write to external file * * How this sample is different from sample 5 ? * * 1. As in sample 5, output is a PKCS#10 CSR * 2. Input and store a cert in cert DB and also used to input, store and trust CA cert. * 3. Like sample 5, but puts cert in header * 4. Like sample 5, but finds key matching cert in header */</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PLOptState <span class="token operator">*</span>optstate<span class="token punctuation">;</span> PLOptStatus status<span class="token punctuation">;</span> PRBool initialized <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> CommandType cmd <span class="token operator">=</span> UNKNOWN<span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> secuPWData pwdata <span class="token operator">=</span> <span class="token punctuation">{</span> PW_NONE<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>subjectStr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTName <span class="token operator">*</span>subject <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> serialNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>serialNumberStr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>trustStr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> CERTCertDBHandle <span class="token operator">*</span>certHandle<span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nickNameStr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>issuerNameStr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PRBool selfsign <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> PRBool ascii <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> PRBool sigVerify <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>outFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>certReqFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>certFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>noiseFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PK11SlotInfo <span class="token operator">*</span>slot <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span> progName <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> progName <span class="token operator">=</span> progName <span class="token operator">?</span> progName <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Parse command line arguments */</span> optstate <span class="token operator">=</span> <span class="token function">PL_CreateOptState</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"GAHEDSVad:i:o:f:p:z:s:r:n:x:m:t:c:u:e:b:v:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">PL_GetNextOpt</span><span class="token punctuation">(</span>optstate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> PL_OPT_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>option<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token string">'a'</span><span class="token operator">:</span> ascii <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'G'</span><span class="token operator">:</span> <span class="token comment">/* Generate a CSR */</span> <span class="token keyword">case</span> <span class="token string">'A'</span><span class="token operator">:</span> <span class="token comment">/* Add cert to database */</span> <span class="token keyword">case</span> <span class="token string">'H'</span><span class="token operator">:</span> <span class="token comment">/* Save cert to the header file */</span> <span class="token keyword">case</span> <span class="token string">'E'</span><span class="token operator">:</span> <span class="token comment">/* Encrypt with public key from cert in header file */</span> <span class="token keyword">case</span> <span class="token string">'S'</span><span class="token operator">:</span> <span class="token comment">/* Sign with private key */</span> <span class="token keyword">case</span> <span class="token string">'D'</span><span class="token operator">:</span> <span class="token comment">/* Decrypt with the matching private key */</span> <span class="token keyword">case</span> <span class="token string">'V'</span><span class="token operator">:</span> <span class="token comment">/* Verify with the matching public key */</span> cmd <span class="token operator">=</span> <span class="token function">option2Command</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'d'</span><span class="token operator">:</span> dbdir <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'f'</span><span class="token operator">:</span> pwdata<span class="token punctuation">.</span>source <span class="token operator">=</span> PW_FROMFILE<span class="token punctuation">;</span> pwdata<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'p'</span><span class="token operator">:</span> pwdata<span class="token punctuation">.</span>source <span class="token operator">=</span> PW_PLAINTEXT<span class="token punctuation">;</span> pwdata<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'i'</span><span class="token operator">:</span> inFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'b'</span><span class="token operator">:</span> headerFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'e'</span><span class="token operator">:</span> encryptedFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'o'</span><span class="token operator">:</span> outFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'z'</span><span class="token operator">:</span> noiseFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token operator">:</span> subjectStr <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> subject <span class="token operator">=</span> <span class="token function">CERT_AsciiToName</span><span class="token punctuation">(</span>subjectStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'r'</span><span class="token operator">:</span> certReqFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'c'</span><span class="token operator">:</span> certFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'u'</span><span class="token operator">:</span> issuerNameStr <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'n'</span><span class="token operator">:</span> nickNameStr <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'x'</span><span class="token operator">:</span> selfsign <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'m'</span><span class="token operator">:</span> serialNumberStr <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> serialNumber <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>serialNumberStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'t'</span><span class="token operator">:</span> trustStr <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'v'</span><span class="token operator">:</span> sigVerify <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token function">PL_DestroyOptState</span><span class="token punctuation">(</span>optstate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> UNKNOWN <span class="token operator">||</span> <span class="token operator">!</span>dbdir<span class="token punctuation">)</span> <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Open DB for read/write and authenticate to it */</span> <span class="token function">PR_Init</span><span class="token punctuation">(</span>PR_USER_THREAD<span class="token punctuation">,</span> PR_PRIORITY_NORMAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> initialized <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">NSS_InitReadWrite</span><span class="token punctuation">(</span>dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"NSS_InitReadWrite Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PK11_SetPasswordFunc</span><span class="token punctuation">(</span>GetModulePassword<span class="token punctuation">)</span><span class="token punctuation">;</span> slot <span class="token operator">=</span> <span class="token function">PK11_GetInternalKeySlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PK11_NeedLogin</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not authenticate to token %s.\n"</span><span class="token punctuation">,</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> GENERATE_CSR<span class="token operator">:</span> <span class="token function">ValidateGenerateCSRCommand</span><span class="token punctuation">(</span>progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> subjectStr<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Generate a CSR */</span> rv <span class="token operator">=</span> <span class="token function">CreateCertRequest</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Create Certificate Request: Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> ADD_CERT_TO_DB<span class="token operator">:</span> <span class="token function">ValidateAddCertToDBCommand</span><span class="token punctuation">(</span>progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> trustStr<span class="token punctuation">,</span> certFileName<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span> issuerNameStr<span class="token punctuation">,</span> serialNumberStr<span class="token punctuation">,</span> selfsign<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Add cert to database */</span> rv <span class="token operator">=</span> <span class="token function">AddCertificateToDB</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span> certFileName<span class="token punctuation">,</span> issuerNameStr<span class="token punctuation">,</span> certHandle<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> trustStr<span class="token punctuation">,</span> serialNumber<span class="token punctuation">,</span> selfsign<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Add Certificate to DB: Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> SAVE_CERT_TO_HEADER<span class="token operator">:</span> <span class="token function">ValidateSaveCertToHeaderCommand</span><span class="token punctuation">(</span>progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Save cert to the header file */</span> rv <span class="token operator">=</span> <span class="token function">AddCertificateToHeader</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> certHandle<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> sigVerify<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Saving Certificate to header: Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> ENCRYPT<span class="token operator">:</span> <span class="token function">ValidateEncryptCommand</span><span class="token punctuation">(</span>progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Encrypt with public key from cert in header file */</span> rv <span class="token operator">=</span> <span class="token function">FindKeyAndEncrypt</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Find public key and Encrypt : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> SIGN<span class="token operator">:</span> <span class="token function">ValidateSignCommand</span><span class="token punctuation">(</span>progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Sign with private key */</span> rv <span class="token operator">=</span> <span class="token function">FindKeyAndSign</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> certHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> nickNameStr<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Find private key and sign : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> DECRYPT<span class="token operator">:</span> <span class="token function">ValidateDecryptCommand</span><span class="token punctuation">(</span>progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">,</span> outFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Decrypt with the matching private key */</span> rv <span class="token operator">=</span> <span class="token function">FindKeyAndDecrypt</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">,</span> outFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Find private key and Decrypt : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> VERIFY<span class="token operator">:</span> <span class="token function">ValidateVerifyCommand</span><span class="token punctuation">(</span>progName<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Verify with the matching public key */</span> rv <span class="token operator">=</span> <span class="token function">FindKeyAndVerify</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> certHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Find public key and verify signature : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSlot</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rvShutdown <span class="token operator">=</span> <span class="token function">NSS_Shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rvShutdown <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed : NSS_Shutdown() - %s"</span><span class="token punctuation">,</span> <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rvShutdown<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PR_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>opfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>encryptfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>encryptfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>serialnumber<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>issuernickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>csr<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>cert<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>trust<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>cert<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>trust<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>csr<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>subject<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>csr<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>issuernickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>trustargs<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>serialnumber<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>opfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>encryptfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>noisefilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbpwdfile<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbpwd<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>infilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>opfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>encryptfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>encryptfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>serialnumber<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>issuernickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>csr<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>cert<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>trust<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>csr<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>subject<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>opfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>encryptfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>encryptfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ipfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>headerfilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>serialnumber<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>issuernickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>csr<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>cert<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>trust<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nickname<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>csr<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>subject<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>noisefilename<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbpwdfile<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbpwd<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dbdirpath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>g<span class="token operator">|</span>a<span class="token operator">|</span>h<span class="token operator">|</span>e<span class="token operator">|</span>ds<span class="token operator">|</span>v<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>sechash<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>secoidt<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>secmodt<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>secoid<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>secport<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>secerr<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>base64<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>cert<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>pk11priv<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>keyhi<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>cryptohi<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>plstr<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>prtypes<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>prlog<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>prinit<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>prerror<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>plgetopt<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>prthread<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
</code></pre></div>