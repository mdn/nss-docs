<h1>Enc Dec MAC Output Public Key as CSR</h1><h2 id="nss_sample_code_5_encryptiondecryption_and_mac_and_output_public_as_a_csr."><a href="#nss_sample_code_5_encryptiondecryption_and_mac_and_output_public_as_a_csr." title="Permalink to NSS Sample Code 5: Encryption/Decryption and MAC and output Public as a CSR.">NSS Sample Code 5: Encryption/Decryption and MAC and output Public as a CSR.</a></h2><div><p class="summary">Generates encryption/mac keys and outputs public key as certificate signing request</p>

<pre class="brush: cpp notranslate"><code><span class="token comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>

<span class="token comment">/* NSPR Headers */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>

<span class="token comment">/* NSS headers */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span></span>

<span class="token comment">/* our samples utilities */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFERSIZE</span>            <span class="token expression"><span class="token number">80</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DIGESTSIZE</span>            <span class="token expression"><span class="token number">16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTEXT_MAC_BUFFER_SIZE</span> <span class="token expression"><span class="token number">96</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CIPHERSIZE</span>            <span class="token expression"><span class="token number">96</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLOCKSIZE</span>             <span class="token expression"><span class="token number">32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_KEY_BITS</span>      <span class="token expression"><span class="token number">1024</span></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CIPHER_HEADER</span>         <span class="token string">"-----BEGIN CIPHER-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CIPHER_TRAILER</span>        <span class="token string">"-----END CIPHER-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENCKEY_HEADER</span>         <span class="token string">"-----BEGIN WRAPPED ENCKEY-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENCKEY_TRAILER</span>        <span class="token string">"-----END WRAPPED ENCKEY-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MACKEY_HEADER</span>         <span class="token string">"-----BEGIN WRAPPED MACKEY-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MACKEY_TRAILER</span>        <span class="token string">"-----END WRAPPED MACKEY-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IV_HEADER</span>             <span class="token string">"-----BEGIN IV-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IV_TRAILER</span>            <span class="token string">"-----END IV-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAC_HEADER</span>            <span class="token string">"-----BEGIN MAC-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAC_TRAILER</span>           <span class="token string">"-----END MAC-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAD_HEADER</span>            <span class="token string">"-----BEGIN PAD-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAD_TRAILER</span>           <span class="token string">"-----END PAD-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LAB_HEADER</span>            <span class="token string">"-----BEGIN KEY LABEL-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LAB_TRAILER</span>           <span class="token string">"-----END KEY LABEL-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PUBKEY_HEADER</span>         <span class="token string">"-----BEGIN PUB KEY -----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PUBKEY_TRAILER</span>        <span class="token string">"-----END PUB KEY -----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NS_CERTREQ_HEADER</span>     <span class="token string">"-----BEGIN NEW CERTIFICATE REQUEST-----"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NS_CERTREQ_TRAILER</span>    <span class="token string">"-----END NEW CERTIFICATE REQUEST-----"</span></span>


<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
    GEN_CSR<span class="token punctuation">,</span>
    ENCRYPT<span class="token punctuation">,</span>
    DECRYPT<span class="token punctuation">,</span>
    UNKNOWN
<span class="token punctuation">}</span> CommandType<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
   SYMKEY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
   MACKEY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
   IV     <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
   MAC    <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
   PAD    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
   PUBKEY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
   LAB    <span class="token operator">=</span> <span class="token number">6</span>
<span class="token punctuation">}</span> HeaderType<span class="token punctuation">;</span>

<span class="token comment">/* This is conditionalized because PORT_ErrorToString was introduced with nss 3.13.
 * Though PR_ErrorToString was available, support for it in nss wasn't.
 * FIXME: samples should determine the version of nss that's available and refuse
 * to run if not 3.13 or higher.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">PORT_ErrorToString</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SEC_ERROR_BASE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEC_ERROR_BASE</span>                          <span class="token expression"><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0x2000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PORT_ErrorToString</span><span class="token expression"><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">PR_ErrorToString</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> PR_LANGUAGE_I_DEFAULT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>


<span class="token comment">/*
 * Print usage message and exit
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">Usage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage:  %s -c  -d  [-z ] "</span>
            <span class="token string">"[-p  | -f ] -s  -r  -i  -o  \n\n"</span><span class="token punctuation">,</span>
            progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s  Specify 'G' for generating RSA keypair for wrapping\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"G"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s  Specify 'E' for encrypt operation\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"E"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s  Specify 'D' for decrypt operation\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s  Specify db directory path\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-d "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s  Specify db password [optional]\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-p "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s  Specify db password file [optional]\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-f "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s  Specify noise file name [optional]\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-z "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-21s Specify subject\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-s "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-21s Specify certficate request file name\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-r "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-21s Specify an input file name\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-i "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-21s Specify an output file name\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">"-o "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s For encrypt, it takes  as an input file and produces\n"</span><span class="token punctuation">,</span>
             <span class="token string">"Note :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s .enc and .header as intermediate output files.\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s For decrypt, it takes .enc and .header\n"</span><span class="token punctuation">,</span>
             <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s as input files and produces  as a final output file.\n\n"</span><span class="token punctuation">,</span>
             <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* Map option letter enumerated commad type */</span>
<span class="token keyword">static</span> CommandType <span class="token function">option2Command</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'G'</span><span class="token operator">:</span> <span class="token keyword">return</span> GEN_CSR<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'E'</span><span class="token operator">:</span> <span class="token keyword">return</span> ENCRYPT<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'D'</span><span class="token operator">:</span> <span class="token keyword">return</span> DECRYPT<span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token keyword">return</span> UNKNOWN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Wrap the symkey using public key
 */</span>
SECStatus
<span class="token function">WrapKey</span><span class="token punctuation">(</span>PK11SymKey<span class="token operator">*</span> key<span class="token punctuation">,</span> SECKEYPublicKey <span class="token operator">*</span>pubKey<span class="token punctuation">,</span> SECItem <span class="token operator">*</span><span class="token operator">*</span>wrappedKey<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv<span class="token punctuation">;</span>
    SECItem <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span>SECItem <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PORT_ZAlloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>SECItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error while allocating memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    data<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token function">SECKEY_PublicKeyStrength</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PORT_ZAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error while allocating memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">PK11_PubWrapSymKey</span><span class="token punctuation">(</span>CKM_RSA_PKCS<span class="token punctuation">,</span> pubKey<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>wrappedKey <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Generate a Symmetric Key
 */</span>
PK11SymKey <span class="token operator">*</span>
<span class="token function">GenerateSYMKey</span><span class="token punctuation">(</span>PK11SlotInfo  <span class="token operator">*</span>slot<span class="token punctuation">,</span> CK_MECHANISM_TYPE mechanism<span class="token punctuation">,</span>
               <span class="token keyword">int</span> keySize<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>keyID<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus      rv<span class="token punctuation">;</span>
    PK11SymKey    <span class="token operator">*</span>key<span class="token punctuation">;</span>

    <span class="token comment">/* Generate the symmetric key */</span>
    key <span class="token operator">=</span> <span class="token function">PK11_TokenKeyGen</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> mechanism<span class="token punctuation">,</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> keySize<span class="token punctuation">,</span> keyID<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Symmetric Key Generation Failed \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * MacInit
 */</span>
SECStatus
<span class="token function">MacInit</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv <span class="token operator">=</span> <span class="token function">PK11_DigestBegin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Compute MAC Failed : PK11_DigestBegin()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * MacUpdate
 */</span>
SECStatus
<span class="token function">MacUpdate</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span>
          <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> msgLen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv <span class="token operator">=</span> <span class="token function">PK11_DigestOp</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Compute MAC Failed : DigestOp()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Finalize MACing
 */</span>
SECStatus
<span class="token function">MacFinal</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span>
         <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>mac<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>macLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxLen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv <span class="token operator">=</span> <span class="token function">PK11_DigestFinal</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> mac<span class="token punctuation">,</span> macLen<span class="token punctuation">,</span> maxLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Compute MAC Failed : PK11_DigestFinal()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Compute Mac
 */</span>
SECStatus
<span class="token function">ComputeMac</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctxmac<span class="token punctuation">,</span>
           <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptext<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ptextLen<span class="token punctuation">,</span>
           <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>mac<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>macLen<span class="token punctuation">,</span>
           <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxLen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv <span class="token operator">=</span> <span class="token function">MacInit</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
    rv <span class="token operator">=</span> <span class="token function">MacUpdate</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> ptextLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
    rv <span class="token operator">=</span> <span class="token function">MacFinal</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> mac<span class="token punctuation">,</span> macLen<span class="token punctuation">,</span> maxLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * WriteToHeaderFile
 */</span>
SECStatus
<span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> HeaderType type<span class="token punctuation">,</span>
                  PRFileDesc <span class="token operator">*</span>outFile<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus      rv<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span>    <span class="token operator">*</span>header<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span>    <span class="token operator">*</span>trailer<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> SYMKEY<span class="token operator">:</span>
        header <span class="token operator">=</span> ENCKEY_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> ENCKEY_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> MACKEY<span class="token operator">:</span>
        header <span class="token operator">=</span>  MACKEY_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> MACKEY_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> IV<span class="token operator">:</span>
        header <span class="token operator">=</span> IV_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> IV_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> MAC<span class="token operator">:</span>
        header <span class="token operator">=</span> MAC_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> MAC_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> PAD<span class="token operator">:</span>
        header <span class="token operator">=</span> PAD_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> PAD_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> PUBKEY<span class="token operator">:</span>
        header <span class="token operator">=</span> PUBKEY_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> PUBKEY_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> LAB<span class="token operator">:</span>
        header <span class="token operator">=</span> LAB_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> LAB_TRAILER<span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n\n"</span><span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PrintAsAscii</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n\n"</span><span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Initialize for encryption or decryption - common code
 */</span>
PK11Context <span class="token operator">*</span>
<span class="token function">CryptInit</span><span class="token punctuation">(</span>PK11SymKey <span class="token operator">*</span>key<span class="token punctuation">,</span>
          <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span>
          CK_MECHANISM_TYPE type<span class="token punctuation">,</span> CK_ATTRIBUTE_TYPE operation<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECItem ivItem <span class="token operator">=</span> <span class="token punctuation">{</span> siBuffer<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen <span class="token punctuation">}</span><span class="token punctuation">;</span>
    PK11Context <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    SECItem <span class="token operator">*</span>secParam <span class="token operator">=</span> <span class="token function">PK11_ParamFromIV</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ivItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>secParam <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Crypt Failed : secParam NULL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx <span class="token operator">=</span> <span class="token function">PK11_CreateContextBySymKey</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> key<span class="token punctuation">,</span> secParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Crypt Failed : can't create a context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>secParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span>secParam<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Common encryption and decryption code
 */</span>
SECStatus
<span class="token function">Crypt</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span>
      <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxOut<span class="token punctuation">,</span>
      <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inLen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv<span class="token punctuation">;</span>

    rv <span class="token operator">=</span> <span class="token function">PK11_CipherOp</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> outLen<span class="token punctuation">,</span> maxOut<span class="token punctuation">,</span> in<span class="token punctuation">,</span> inLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Crypt Failed : PK11_CipherOp returned %d\n"</span><span class="token punctuation">,</span> rv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Decrypt
 */</span>
SECStatus
<span class="token function">Decrypt</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxout<span class="token punctuation">,</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inLen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Crypt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> outLen<span class="token punctuation">,</span> maxout<span class="token punctuation">,</span> in<span class="token punctuation">,</span> inLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Encrypt
 */</span>
SECStatus
<span class="token function">Encrypt</span><span class="token punctuation">(</span>PK11Context<span class="token operator">*</span> ctx<span class="token punctuation">,</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxout<span class="token punctuation">,</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inLen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Crypt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> outLen<span class="token punctuation">,</span> maxout<span class="token punctuation">,</span> in<span class="token punctuation">,</span> inLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * EncryptInit
 */</span>
PK11Context <span class="token operator">*</span>
<span class="token function">EncryptInit</span><span class="token punctuation">(</span>PK11SymKey <span class="token operator">*</span>ek<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span>
            CK_MECHANISM_TYPE type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">CryptInit</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> type<span class="token punctuation">,</span> CKA_ENCRYPT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * DecryptInit
 */</span>
PK11Context <span class="token operator">*</span>
<span class="token function">DecryptInit</span><span class="token punctuation">(</span>PK11SymKey <span class="token operator">*</span>dk<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span>
            CK_MECHANISM_TYPE type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">CryptInit</span><span class="token punctuation">(</span>dk<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> type<span class="token punctuation">,</span> CKA_DECRYPT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Read cryptographic parameters from the header file
 */</span>
SECStatus
<span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fileName<span class="token punctuation">,</span> HeaderType type<span class="token punctuation">,</span>
                   SECItem <span class="token operator">*</span>item<span class="token punctuation">,</span> PRBool isHexData<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus      rv<span class="token punctuation">;</span>
    SECItem        filedata<span class="token punctuation">;</span>
    SECItem        outbuf<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>nonbody<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>body<span class="token punctuation">;</span>
    <span class="token keyword">char</span>          <span class="token operator">*</span>header<span class="token punctuation">;</span>
    <span class="token keyword">char</span>          <span class="token operator">*</span>trailer<span class="token punctuation">;</span>
    PRFileDesc    <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    outbuf<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span>
    file <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to open %s\n"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> PUBKEY<span class="token operator">:</span>
        header <span class="token operator">=</span> PUBKEY_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> PUBKEY_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYMKEY<span class="token operator">:</span>
        header <span class="token operator">=</span> ENCKEY_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> ENCKEY_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> MACKEY<span class="token operator">:</span>
        header <span class="token operator">=</span> MACKEY_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> MACKEY_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> IV<span class="token operator">:</span>
        header <span class="token operator">=</span> IV_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> IV_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> MAC<span class="token operator">:</span>
        header <span class="token operator">=</span> MAC_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> MAC_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> PAD<span class="token operator">:</span>
        header <span class="token operator">=</span> PAD_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> PAD_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> LAB<span class="token operator">:</span>
        header <span class="token operator">=</span> LAB_HEADER<span class="token punctuation">;</span>
        trailer <span class="token operator">=</span> LAB_TRAILER<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">PR_Close</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">FileToItem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filedata<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nonbody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nonbody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to read data from input file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* check for headers and trailers and remove them */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>body <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>nonbody<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        nonbody <span class="token operator">=</span> body<span class="token punctuation">;</span>
        body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">)</span>
            body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>nonbody<span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* maybe this is a MAC file */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span>
            trail <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token operator">++</span>body<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>  <span class="token string">"input has header but no trailer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* headers didn't exist */</span>
        body <span class="token operator">=</span> nonbody<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            trail <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token operator">++</span>body<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>trail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
                    <span class="token string">"input has no header but has trailer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

cleanup<span class="token operator">:</span>
    <span class="token function">PR_Close</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ATOB_ConvertAsciiToItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Generate the private key
 */</span>
SECKEYPrivateKey <span class="token operator">*</span>
<span class="token function">GeneratePrivateKey</span><span class="token punctuation">(</span>KeyType keytype<span class="token punctuation">,</span> PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> publicExponent<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>noiseFileName<span class="token punctuation">,</span>
                   SECKEYPublicKey <span class="token operator">*</span><span class="token operator">*</span>pubkeyp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pqgFile<span class="token punctuation">,</span>
                   secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    CK_MECHANISM_TYPE  mechanism<span class="token punctuation">;</span>
    SECOidTag          algtag<span class="token punctuation">;</span>
    PK11RSAGenParams   rsaparams<span class="token punctuation">;</span>
    <span class="token keyword">void</span>              <span class="token operator">*</span>params<span class="token punctuation">;</span>
    SECKEYPrivateKey  <span class="token operator">*</span>privKey    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECStatus          rv<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      randbuf<span class="token punctuation">[</span>BLOCKSIZE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    rv <span class="token operator">=</span> <span class="token function">GenerateRandom</span><span class="token punctuation">(</span>randbuf<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error while generating the random numbers : %s\n"</span><span class="token punctuation">,</span>
                <span class="token function">PORT_ErrorToString</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">PK11_RandomUpdate</span><span class="token punctuation">(</span>randbuf<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>keytype<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> rsaKey<span class="token operator">:</span>
            rsaparams<span class="token punctuation">.</span>keySizeInBits <span class="token operator">=</span> size<span class="token punctuation">;</span>
            rsaparams<span class="token punctuation">.</span>pe            <span class="token operator">=</span> publicExponent<span class="token punctuation">;</span>
            mechanism               <span class="token operator">=</span> CKM_RSA_PKCS_KEY_PAIR_GEN<span class="token punctuation">;</span>
            algtag                  <span class="token operator">=</span> SEC_OID_PKCS1_MD5_WITH_RSA_ENCRYPTION<span class="token punctuation">;</span>
            params                  <span class="token operator">=</span> <span class="token operator">&amp;</span>rsaparams<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Generating key.  This may take a few moments...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    privKey <span class="token operator">=</span> <span class="token function">PK11_GenerateKeyPair</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> mechanism<span class="token punctuation">,</span> params<span class="token punctuation">,</span> pubkeyp<span class="token punctuation">,</span>
                                       PR_TRUE <span class="token comment">/*isPerm*/</span><span class="token punctuation">,</span> PR_TRUE <span class="token comment">/*isSensitive*/</span><span class="token punctuation">,</span>
                                       pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
cleanup<span class="token operator">:</span>
    <span class="token keyword">return</span> privKey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Extract the public key request from CSR
 */</span>
SECKEYPublicKey <span class="token operator">*</span>
<span class="token function">ExtractPublicKeyFromCertRequest</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    CERTSignedData signedData<span class="token punctuation">;</span>
    SECItem reqDER<span class="token punctuation">;</span>
    CERTCertificateRequest <span class="token operator">*</span>certReq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECStatus rv                    <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span>
    PRArenaPool <span class="token operator">*</span>arena              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECKEYPublicKey <span class="token operator">*</span>publicKey      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    arena <span class="token operator">=</span> <span class="token function">PORT_NewArena</span><span class="token punctuation">(</span>DER_DEFAULT_CHUNKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arena <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">ReadDERFromFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reqDER<span class="token punctuation">,</span> inFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    certReq <span class="token operator">=</span> <span class="token punctuation">(</span>CERTCertificateRequest<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">PORT_ArenaZAlloc</span>
               <span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CERTCertificateRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>certReq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    certReq<span class="token operator">-&gt;</span>arena <span class="token operator">=</span> arena<span class="token punctuation">;</span>

    <span class="token comment">/* Since cert request is a signed data, must decode to get the inner
       data
    */</span>
    <span class="token function">PORT_Memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>signedData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signedData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rv <span class="token operator">=</span> <span class="token function">SEC_ASN1DecodeItem</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token operator">&amp;</span>signedData<span class="token punctuation">,</span>
                            <span class="token function">SEC_ASN1_GET</span><span class="token punctuation">(</span>CERT_SignedDataTemplate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>reqDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rv <span class="token operator">=</span> <span class="token function">SEC_ASN1DecodeItem</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> certReq<span class="token punctuation">,</span>
                            <span class="token function">SEC_ASN1_GET</span><span class="token punctuation">(</span>CERT_CertificateRequestTemplate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>signedData<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rv <span class="token operator">=</span> <span class="token function">CERT_VerifySignedDataWithPublicKeyInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>signedData<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>certReq<span class="token operator">-&gt;</span>subjectPublicKeyInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token comment">/* wincx */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    publicKey <span class="token operator">=</span> <span class="token function">SECKEY_ExtractPublicKey</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>certReq<span class="token operator">-&gt;</span>subjectPublicKeyInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reqDER<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reqDER<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PORT_FreeArena</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> publicKey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Get the private key corresponding to public key
 */</span>
SECKEYPrivateKey <span class="token operator">*</span>
<span class="token function">GetRSAPrivateKey</span><span class="token punctuation">(</span>PK11SlotInfo    <span class="token operator">*</span>slot<span class="token punctuation">,</span>
                secuPWData       <span class="token operator">*</span>pwdata<span class="token punctuation">,</span>
                SECKEYPublicKey  <span class="token operator">*</span>pubKey<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECKEYPrivateKey         <span class="token operator">*</span>privKey   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECItem                  <span class="token operator">*</span>cka_id<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Empty Slot\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span> <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"could not authenticate to token %s."</span><span class="token punctuation">,</span>
                <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cka_id  <span class="token operator">=</span> <span class="token operator">&amp;</span>pubKey<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>rsa<span class="token punctuation">.</span>modulus<span class="token punctuation">;</span>
    cka_id  <span class="token operator">=</span> <span class="token function">PK11_MakeIDFromPubKey</span><span class="token punctuation">(</span>cka_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    privKey <span class="token operator">=</span> <span class="token function">PK11_FindKeyByKeyID</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> cka_id<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
cleanup<span class="token operator">:</span>
    <span class="token keyword">return</span> privKey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 *  Generate the certificate request with subject
 */</span>
<span class="token keyword">static</span> SECStatus
<span class="token function">CertReq</span><span class="token punctuation">(</span>SECKEYPrivateKey <span class="token operator">*</span>privk<span class="token punctuation">,</span> SECKEYPublicKey <span class="token operator">*</span>pubk<span class="token punctuation">,</span> KeyType keyType<span class="token punctuation">,</span>
        SECOidTag hashAlgTag<span class="token punctuation">,</span> CERTName <span class="token operator">*</span>subject<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>certReqFileName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    CERTSubjectPublicKeyInfo <span class="token operator">*</span>spki          <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    CERTCertificateRequest   <span class="token operator">*</span>cr            <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECItem                  <span class="token operator">*</span>encoding      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECOidTag                 signAlgTag<span class="token punctuation">;</span>
    SECItem                   result<span class="token punctuation">;</span>
    SECStatus                 rv            <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span>
    PRInt32                   numBytes<span class="token punctuation">;</span>
    <span class="token keyword">void</span>                     <span class="token operator">*</span>extHandle<span class="token punctuation">;</span>
    PRArenaPool              <span class="token operator">*</span>arena         <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRFileDesc               <span class="token operator">*</span>outFile       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/*  Open the certificate request file to write */</span>
    outFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>certReqFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_RDWR <span class="token operator">|</span> PR_TRUNCATE<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
                   <span class="token string">"unable to open \"%s\" for writing (%ld, %ld).\n"</span><span class="token punctuation">,</span>
                   certReqFileName<span class="token punctuation">,</span> <span class="token function">PR_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PR_GetOSError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Create info about public key */</span>
    spki <span class="token operator">=</span> <span class="token function">SECKEY_CreateSubjectPublicKeyInfo</span><span class="token punctuation">(</span>pubk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spki<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to create subject public key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Generate certificate request */</span>
    cr <span class="token operator">=</span> <span class="token function">CERT_CreateCertificateRequest</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> spki<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to make certificate request\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    arena <span class="token operator">=</span> <span class="token function">PORT_NewArena</span><span class="token punctuation">(</span>DER_DEFAULT_CHUNKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"out of memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    extHandle <span class="token operator">=</span> <span class="token function">CERT_StartCertificateRequestAttributes</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extHandle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PORT_FreeArena</span> <span class="token punctuation">(</span>arena<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CERT_FinishExtensions</span><span class="token punctuation">(</span>extHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CERT_FinishCertificateRequestAttributes</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Der encode the request */</span>
    encoding <span class="token operator">=</span> <span class="token function">SEC_ASN1EncodeItem</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> cr<span class="token punctuation">,</span>
                                  <span class="token function">SEC_ASN1_GET</span><span class="token punctuation">(</span>CERT_CertificateRequestTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"der encoding of request failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Sign the request */</span>
    signAlgTag <span class="token operator">=</span> <span class="token function">SEC_GetSignatureAlgorithmOidTag</span><span class="token punctuation">(</span>keyType<span class="token punctuation">,</span> hashAlgTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>signAlgTag <span class="token operator">==</span> SEC_OID_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unknown Key or Hash type\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rv <span class="token operator">=</span> <span class="token function">SEC_DerSignData</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">,</span> encoding<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> encoding<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span>
                         privk<span class="token punctuation">,</span> signAlgTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"signing of data failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Encode request in specified format */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>obuf<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token operator">*</span>email<span class="token punctuation">,</span> <span class="token operator">*</span>org<span class="token punctuation">,</span> <span class="token operator">*</span>state<span class="token punctuation">,</span> <span class="token operator">*</span>country<span class="token punctuation">;</span>
        SECItem <span class="token operator">*</span>it<span class="token punctuation">;</span>
        <span class="token keyword">int</span> total<span class="token punctuation">;</span>

        it <span class="token operator">=</span> <span class="token operator">&amp;</span>result<span class="token punctuation">;</span>

        obuf <span class="token operator">=</span> <span class="token function">BTOA_ConvertItemToAscii</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
        total <span class="token operator">=</span> <span class="token function">PL_strlen</span><span class="token punctuation">(</span>obuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        name <span class="token operator">=</span> <span class="token function">CERT_GetCommonName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        email <span class="token operator">=</span> <span class="token function">CERT_GetCertEmailAddress</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span>
            email <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        org <span class="token operator">=</span> <span class="token function">CERT_GetOrgName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>org<span class="token punctuation">)</span>
            org <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        state <span class="token operator">=</span> <span class="token function">CERT_GetStateName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span>
            state <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        country <span class="token operator">=</span> <span class="token function">CERT_GetCountryName</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>country<span class="token punctuation">)</span>
            country <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"(not specified)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span>
                   <span class="token string">"\nCertificate request generated by Netscape certutil\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Common Name: %s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Email: %s\n"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Organization: %s\n"</span><span class="token punctuation">,</span> org<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"State: %s\n"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"Country: %s\n\n"</span><span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> NS_CERTREQ_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        numBytes <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> obuf<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"write error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"\n%s\n"</span><span class="token punctuation">,</span> NS_CERTREQ_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obuf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PORT_Free</span><span class="token punctuation">(</span>obuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        numBytes <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> result<span class="token punctuation">.</span>data<span class="token punctuation">,</span> result<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result<span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"write error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
	    <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spki<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token function">SECKEY_DestroySubjectPublicKeyInfo</span><span class="token punctuation">(</span>spki<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CERT_DestroyCertificateRequest</span> <span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PORT_FreeArena</span><span class="token punctuation">(</span>arena<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token function">PR_Close</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Mac and Encrypt the input file content
 */</span>
SECStatus
<span class="token function">EncryptAndMac</span><span class="token punctuation">(</span>PRFileDesc <span class="token operator">*</span>inFile<span class="token punctuation">,</span>
              PRFileDesc <span class="token operator">*</span>headerFile<span class="token punctuation">,</span>
              PRFileDesc <span class="token operator">*</span>encFile<span class="token punctuation">,</span>
              PK11SymKey <span class="token operator">*</span>ek<span class="token punctuation">,</span>
              PK11SymKey <span class="token operator">*</span>mk<span class="token punctuation">,</span>
              <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span>
              PRBool ascii<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus      rv<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  ptext<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   ptextLen<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  mac<span class="token punctuation">[</span>DIGESTSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   macLen<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   nwritten<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  encbuf<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   encbufLen<span class="token punctuation">;</span>
    SECItem        noParams <span class="token operator">=</span> <span class="token punctuation">{</span> siBuffer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    PK11Context   <span class="token operator">*</span>ctxmac <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PK11Context   <span class="token operator">*</span>ctxenc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   pad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    SECItem        padItem<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   paddingLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> firstTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>

    ctxmac <span class="token operator">=</span> <span class="token function">PK11_CreateContextBySymKey</span><span class="token punctuation">(</span>CKM_MD5_HMAC<span class="token punctuation">,</span> CKA_SIGN<span class="token punctuation">,</span> mk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>noParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't create MAC context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rv <span class="token operator">=</span> <span class="token function">MacInit</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ctxenc <span class="token operator">=</span> <span class="token function">EncryptInit</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> CKM_AES_CBC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* read a buffer of plaintext from input file */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptextLen <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ptext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Encrypt using it using CBC, using previously created IV */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ptextLen <span class="token operator">!=</span> BLOCKSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            paddingLength <span class="token operator">=</span> BLOCKSIZE <span class="token operator">-</span> ptextLen<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> paddingLength<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ptext<span class="token punctuation">[</span>ptextLen<span class="token operator">+</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>paddingLength<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ptextLen <span class="token operator">=</span> BLOCKSIZE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rv  <span class="token operator">=</span> <span class="token function">Encrypt</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span>
                encbuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encbufLen<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>encbuf<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ptext<span class="token punctuation">,</span> ptextLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Encrypt Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* save the last block of ciphertext as the next IV */</span>
        iv <span class="token operator">=</span> encbuf<span class="token punctuation">;</span>
        ivLen <span class="token operator">=</span> encbufLen<span class="token punctuation">;</span>

        <span class="token comment">/* write the cipher text to intermediate file */</span>
        nwritten <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>encFile<span class="token punctuation">,</span> encbuf<span class="token punctuation">,</span> encbufLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*PR_Assert(nwritten == encbufLen);*/</span>

        rv <span class="token operator">=</span> <span class="token function">MacUpdate</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> ptextLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">MacFinal</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> mac<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macLen<span class="token punctuation">,</span> DIGESTSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"MacFinal Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>macLen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Bad MAC length\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>mac<span class="token punctuation">,</span> macLen<span class="token punctuation">,</span> MAC<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Write MAC Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> paddingLength<span class="token punctuation">;</span>
    padItem<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span>
    padItem<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pad<span class="token punctuation">;</span>
    padItem<span class="token punctuation">.</span>len  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>padItem<span class="token punctuation">.</span>data<span class="token punctuation">,</span> padItem<span class="token punctuation">.</span>len<span class="token punctuation">,</span> PAD<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Write PAD Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxenc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Decrypt and Verify MAC
 */</span>
SECStatus
<span class="token function">DecryptAndVerifyMac</span><span class="token punctuation">(</span>PRFileDesc <span class="token operator">*</span>outFile<span class="token punctuation">,</span>
    PRFileDesc <span class="token operator">*</span>inFile<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inFileLength<span class="token punctuation">,</span>
    SECItem <span class="token operator">*</span>cItem<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>macItem<span class="token punctuation">,</span>
    PK11SymKey<span class="token operator">*</span> ek<span class="token punctuation">,</span> PK11SymKey<span class="token operator">*</span> mk<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>ivItem<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>padItem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus      rv<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  decbuf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   decbufLen<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  ptext<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   ptextLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  ctext<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   ctextLen<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  newmac<span class="token punctuation">[</span>DIGESTSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   newmacLen                 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   newptextLen               <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   count                     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   temp                      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   blockNumber               <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    SECItem        noParams <span class="token operator">=</span> <span class="token punctuation">{</span> siBuffer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    PK11Context   <span class="token operator">*</span>ctxmac <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PK11Context   <span class="token operator">*</span>ctxenc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> iv<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen <span class="token operator">=</span> ivItem<span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> paddingLength<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> ivItem<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> ivItem<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    paddingLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>padItem<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    ctxmac <span class="token operator">=</span> <span class="token function">PK11_CreateContextBySymKey</span><span class="token punctuation">(</span>CKM_MD5_HMAC<span class="token punctuation">,</span> CKA_SIGN<span class="token punctuation">,</span> mk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>noParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't create MAC context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">MacInit</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>

    ctxenc <span class="token operator">=</span> <span class="token function">DecryptInit</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> CKM_AES_CBC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ctextLen <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> ctext<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ctext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        count <span class="token operator">+=</span> ctextLen<span class="token punctuation">;</span>

        <span class="token comment">/* decrypt cipher text buffer using CBC and IV */</span>

        rv <span class="token operator">=</span> <span class="token function">Decrypt</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span> decbuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>decbufLen<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>decbuf<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     ctext<span class="token punctuation">,</span> ctextLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Decrypt Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>decbufLen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

        rv <span class="token operator">=</span> <span class="token function">MacUpdate</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> decbuf<span class="token punctuation">,</span> decbufLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> inFileLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            decbufLen <span class="token operator">=</span> decbufLen<span class="token operator">-</span>paddingLength<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* write the plain text to out file */</span>
        temp <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> decbuf<span class="token punctuation">,</span> decbufLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">!=</span> decbufLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"write error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        blockNumber<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">MacFinal</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> newmac<span class="token punctuation">,</span> <span class="token operator">&amp;</span>newmacLen<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newmac<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PORT_Memcmp</span><span class="token punctuation">(</span>macItem<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> newmac<span class="token punctuation">,</span> newmacLen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Check MAC : Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Extracted : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PrintAsAscii</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> macItem<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> macItem<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Computed  : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PrintAsAscii</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> newmac<span class="token punctuation">,</span> newmacLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxenc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Open intermediate file, read in IV, wrapped encryption key,
 * wrapped MAC key, MAC, PAD and public key from header file
 */</span>
SECStatus
<span class="token function">GetDataFromHeader</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span>
                  SECItem <span class="token operator">*</span>ivItem<span class="token punctuation">,</span>
                  SECItem <span class="token operator">*</span>wrappedEncKeyItem<span class="token punctuation">,</span>
                  SECItem <span class="token operator">*</span>wrappedMacKeyItem<span class="token punctuation">,</span>
                  SECItem <span class="token operator">*</span>macItem<span class="token punctuation">,</span>
                  SECItem <span class="token operator">*</span>padItem<span class="token punctuation">,</span>
                  SECKEYPublicKey <span class="token operator">*</span><span class="token operator">*</span>pubKey<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span>
    CERTSubjectPublicKeyInfo <span class="token operator">*</span>keyInfo <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECItem pubKeyData<span class="token punctuation">;</span>

    <span class="token comment">/* Read in the IV into item from the header file */</span>
    rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> IV<span class="token punctuation">,</span> ivItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not retrieve IV from cipher file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> SYMKEY<span class="token punctuation">,</span> wrappedEncKeyItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
        <span class="token string">"Could not retrieve wrapped AES key from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Read in the MAC key into item from the header file */</span>
    rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> MACKEY<span class="token punctuation">,</span> wrappedMacKeyItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
        <span class="token string">"Could not retrieve wrapped MAC key from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Get the public key from header file */</span>
    rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PUBKEY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pubKeyData<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
        <span class="token string">"Could not retrieve public key from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    keyInfo    <span class="token operator">=</span> <span class="token function">SECKEY_DecodeDERSubjectPublicKeyInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pubKeyData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not decode public key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>pubKey <span class="token operator">=</span> <span class="token function">SECKEY_ExtractPublicKey</span><span class="token punctuation">(</span>keyInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pubKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error while getting RSA public key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Read in the Mac into item from the header file */</span>
    rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> MAC<span class="token punctuation">,</span> macItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
        <span class="token string">"Could not retrieve MAC from cipher file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>macItem<span class="token operator">-&gt;</span>data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"MAC has NULL data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>macItem<span class="token operator">-&gt;</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"MAC has data has 0 length\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Read in the PAD into item from the header file */</span>
    rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PAD<span class="token punctuation">,</span> padItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
        <span class="token string">"Could not retrieve PAD detail from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * DecryptFile
 */</span>
SECStatus
<span class="token function">DecryptFile</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>outFileName<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span>
             <span class="token keyword">char</span>         <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span>
             secuPWData   <span class="token operator">*</span>pwdata<span class="token punctuation">,</span>
             PRBool       ascii<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/*
     * The DB is open read only and we have authenticated to it
     * open input file, read in header, get IV and wrapped keys and
     * public key
     * Unwrap the wrapped keys
     * loop until EOF(input):
     *     read a buffer of ciphertext from input file,
     *     Save last block of ciphertext
     *     decrypt ciphertext buffer using CBC and IV,
     *     compute and check MAC, then remove MAC from plaintext
     *     replace IV with saved last block of ciphertext
     *     write the plain text to output file
     * close files
     * report success
     */</span>

    SECStatus           rv<span class="token punctuation">;</span>
    SECItem             ivItem<span class="token punctuation">;</span>
    SECItem             wrappedEncKeyItem<span class="token punctuation">;</span>
    SECItem             wrappedMacKeyItem<span class="token punctuation">;</span>
    SECItem             cipherItem<span class="token punctuation">;</span>
    SECItem             macItem<span class="token punctuation">;</span>
    SECItem             padItem<span class="token punctuation">;</span>
    SECKEYPublicKey    <span class="token operator">*</span>pubKey              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PK11SymKey         <span class="token operator">*</span>encKey              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PK11SymKey         <span class="token operator">*</span>macKey              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECKEYPrivateKey   <span class="token operator">*</span>privKey             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRFileDesc         <span class="token operator">*</span>outFile             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRFileDesc         <span class="token operator">*</span>inFile              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>       inFileLength         <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* open intermediate file, read in header, get IV, public key and
     * CKA_IDs of two keys from it
     */</span>
    rv <span class="token operator">=</span> <span class="token function">GetDataFromHeader</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>ivItem<span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>wrappedEncKeyItem<span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>wrappedMacKeyItem<span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>macItem<span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>padItem<span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* find private key from the DB token using public key */</span>
    privKey <span class="token operator">=</span> <span class="token function">GetRSAPrivateKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> pwdata<span class="token punctuation">,</span> pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>privKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't find private key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    encKey <span class="token operator">=</span> <span class="token function">PK11_PubUnwrapSymKey</span><span class="token punctuation">(</span>privKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wrappedEncKeyItem<span class="token punctuation">,</span>
                                  CKM_AES_CBC<span class="token punctuation">,</span> CKA_ENCRYPT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't unwrap the encryption key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* CKM_MD5_HMAC or CKM_EXTRACT_KEY_FROM_KEY */</span>
    macKey <span class="token operator">=</span> <span class="token function">PK11_PubUnwrapSymKey</span><span class="token punctuation">(</span>privKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wrappedMacKeyItem<span class="token punctuation">,</span>
                                  CKM_MD5_HMAC<span class="token punctuation">,</span> CKA_SIGN<span class="token punctuation">,</span> <span class="token number">160</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't unwrap the Mac key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*  Open the input file.  */</span>
    inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> PR_RDONLY <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
                   <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span>
                   encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*  Open the output file.  */</span>
    outFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>outFileName<span class="token punctuation">,</span>
                      PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR <span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
                   <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span>
                   outFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    inFileLength <span class="token operator">=</span> <span class="token function">FileSize</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">==</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Decrypt and Remove Mac */</span>
        rv <span class="token operator">=</span> <span class="token function">DecryptAndVerifyMac</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> inFile<span class="token punctuation">,</span> inFileLength<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>cipherItem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macItem<span class="token punctuation">,</span> encKey<span class="token punctuation">,</span> macKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ivItem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>padItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed while decrypting and removing MAC\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>encKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>macKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>privKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECKEY_DestroyPrivateKey</span><span class="token punctuation">(</span>privKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECKEY_DestroyPublicKey</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * EncryptFile
 */</span>
SECStatus
<span class="token function">EncryptFile</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>inFileName<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>certReqFileName<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>noiseFileName<span class="token punctuation">,</span>
             secuPWData   <span class="token operator">*</span>pwdata<span class="token punctuation">,</span>
             PRBool       ascii<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/*
     * The DB is open for read/write and we have authenticated to it.
     * Read public key from certificate request
     * generate a symmetric AES key as a session object.
     * generate a second key to use for MACing, also a session object.
     * generate a random value to use as IV for AES CBC
     * open an input file and an output file,
     * Wrap the symmetric and MAC keys using public key
     * write a header to the output that identifies the two wrapped keys
     * and public key
     * loop until EOF(input)
     *    read a buffer of plaintext from input file,
     *    MAC it, append the MAC to the plaintext
     *    encrypt it using CBC, using previously created IV,
     *    store the last block of ciphertext as the new IV,
     *    write the cipher text to intermediate file
     *    close files
     *    report success
     */</span>
    SECStatus           rv<span class="token punctuation">;</span>
    SECKEYPublicKey    <span class="token operator">*</span>pubKey        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECItem            <span class="token operator">*</span>pubKeyData    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRFileDesc         <span class="token operator">*</span>inFile        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRFileDesc         <span class="token operator">*</span>headerFile    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRFileDesc         <span class="token operator">*</span>encFile       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      <span class="token operator">*</span>encKeyId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"Encrypt Key"</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      <span class="token operator">*</span>macKeyId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"MAC Key"</span><span class="token punctuation">;</span>
    SECItem encKeyID <span class="token operator">=</span> <span class="token punctuation">{</span> siAsciiString<span class="token punctuation">,</span> encKeyId<span class="token punctuation">,</span> <span class="token function">PL_strlen</span><span class="token punctuation">(</span>encKeyId<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    SECItem macKeyID <span class="token operator">=</span> <span class="token punctuation">{</span> siAsciiString<span class="token punctuation">,</span> macKeyId<span class="token punctuation">,</span> <span class="token function">PL_strlen</span><span class="token punctuation">(</span>macKeyId<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>       iv<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    SECItem             ivItem<span class="token punctuation">;</span>
    PK11SymKey         <span class="token operator">*</span>encKey        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PK11SymKey         <span class="token operator">*</span>macKey        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECItem            <span class="token operator">*</span>wrappedEncKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECItem            <span class="token operator">*</span>wrappedMacKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>       c<span class="token punctuation">;</span>

    pubKey <span class="token operator">=</span> <span class="token function">ExtractPublicKeyFromCertRequest</span><span class="token punctuation">(</span>certReqFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pubKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error while getting RSA public key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* generate a symmetric AES key as a token object. */</span>
    encKey <span class="token operator">=</span> <span class="token function">GenerateSYMKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> CKM_AES_KEY_GEN<span class="token punctuation">,</span> <span class="token number">128</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>encKeyID<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"GenerateSYMKey for AES returned NULL.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* generate a second key to use for MACing, also a token object. */</span>
    macKey <span class="token operator">=</span> <span class="token function">GenerateSYMKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> CKM_GENERIC_SECRET_KEY_GEN<span class="token punctuation">,</span> <span class="token number">160</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>macKeyID<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"GenerateSYMKey for MACing returned NULL.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Wrap encrypt key */</span>
    rv <span class="token operator">=</span> <span class="token function">WrapKey</span><span class="token punctuation">(</span>encKey<span class="token punctuation">,</span> pubKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wrappedEncKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error while wrapping encrypt key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Wrap Mac key */</span>
    rv <span class="token operator">=</span> <span class="token function">WrapKey</span><span class="token punctuation">(</span>macKey<span class="token punctuation">,</span> pubKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wrappedMacKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error while wrapping Mac key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>noiseFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> <span class="token function">SeedFromNoiseFile</span><span class="token punctuation">(</span>noiseFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PORT_SetError</span><span class="token punctuation">(</span>PR_END_OF_FILE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rv <span class="token operator">=</span> <span class="token function">PK11_GenerateRandom</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* generate a random value to use as IV for AES CBC */</span>
        <span class="token function">GenerateRandom</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    headerFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span>
                         PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
                   <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span>
                   headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    encFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span>
                      PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>
                   <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span>
                   encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* write to a header file the IV and the CKA_IDs
     * identifying the two keys
     */</span>
    ivItem<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span>
    ivItem<span class="token punctuation">.</span>data <span class="token operator">=</span> iv<span class="token punctuation">;</span>
    ivItem<span class="token punctuation">.</span>len <span class="token operator">=</span> BLOCKSIZE<span class="token punctuation">;</span>

    rv <span class="token operator">=</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">,</span> IV<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error writing IV to cipher file - %s\n"</span><span class="token punctuation">,</span>
                   headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rv <span class="token operator">=</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>wrappedEncKey<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> wrappedEncKey<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span> SYMKEY<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error writing wrapped AES key to cipher file - %s\n"</span><span class="token punctuation">,</span>
        encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rv <span class="token operator">=</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>wrappedMacKey<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> wrappedMacKey<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span> MACKEY<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error writing wrapped MAC key to cipher file - %s\n"</span><span class="token punctuation">,</span>
                   headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pubKeyData <span class="token operator">=</span> <span class="token function">SECKEY_EncodeDERSubjectPublicKeyInfo</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rv <span class="token operator">=</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>pubKeyData<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> pubKeyData<span class="token operator">-&gt;</span>len<span class="token punctuation">,</span> PUBKEY<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error writing wrapped AES key to cipher file - %s\n"</span><span class="token punctuation">,</span>
                   headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*  Open the input file.  */</span>
    inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span>
                   inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Macing and Encryption */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">==</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> <span class="token function">EncryptAndMac</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> headerFile<span class="token punctuation">,</span> encFile<span class="token punctuation">,</span>
                encKey<span class="token punctuation">,</span> macKey<span class="token punctuation">,</span> ivItem<span class="token punctuation">.</span>data<span class="token punctuation">,</span> ivItem<span class="token punctuation">.</span>len<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed : Macing and Encryption\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_Close</span><span class="token punctuation">(</span>inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_Close</span><span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_Close</span><span class="token punctuation">(</span>encFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>encKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>macKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wrappedEncKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span>wrappedEncKey<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wrappedMacKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span>wrappedMacKey<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECKEY_DestroyPublicKey</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pubKeyData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span>pubKeyData<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Create certificate request with subject
 */</span>
SECStatus <span class="token function">CreateCertificateRequest</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>dbdir<span class="token punctuation">,</span>
                                   secuPWData   <span class="token operator">*</span>pwdata<span class="token punctuation">,</span>
                                   CERTName     <span class="token operator">*</span>subject<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token keyword">char</span>   <span class="token operator">*</span>certReqFileName<span class="token punctuation">,</span>
                                   PRBool       ascii<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv<span class="token punctuation">;</span>
    SECKEYPrivateKey    <span class="token operator">*</span>privkey         <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    SECKEYPublicKey     <span class="token operator">*</span>pubkey          <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    KeyType             keytype          <span class="token operator">=</span> rsaKey<span class="token punctuation">;</span>
    <span class="token keyword">int</span>                 keysize          <span class="token operator">=</span> DEFAULT_KEY_BITS<span class="token punctuation">;</span>
    <span class="token keyword">int</span>                 publicExponent   <span class="token operator">=</span> <span class="token number">0x010001</span><span class="token punctuation">;</span>
    SECOidTag           hashAlgTag       <span class="token operator">=</span> SEC_OID_UNKNOWN<span class="token punctuation">;</span>

    privkey <span class="token operator">=</span> <span class="token function">GeneratePrivateKey</span><span class="token punctuation">(</span>keytype<span class="token punctuation">,</span> slot<span class="token punctuation">,</span> keysize<span class="token punctuation">,</span>
                                 publicExponent<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                                 <span class="token operator">&amp;</span>pubkey<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>privkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to generate key(s)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    privkey<span class="token operator">-&gt;</span>wincx <span class="token operator">=</span> pwdata<span class="token punctuation">;</span>
    <span class="token function">PORT_Assert</span><span class="token punctuation">(</span>pubkey <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    rv <span class="token operator">=</span> <span class="token function">CertReq</span><span class="token punctuation">(</span>privkey<span class="token punctuation">,</span> pubkey<span class="token punctuation">,</span> keytype<span class="token punctuation">,</span> hashAlgTag<span class="token punctuation">,</span> subject<span class="token punctuation">,</span>
                 ascii<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to create Certificate Request\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>privkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECKEY_DestroyPrivateKey</span><span class="token punctuation">(</span>privkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SECKEY_DestroyPublicKey</span><span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * This example illustrates basic encryption/decryption and MACing
 * Generates the RSA key pair as token object and outputs public key as cert request.
 * Generates the encryption/mac keys as session objects.
 * Encrypts/MACs the input file using encryption keys and outputs the encrypted
 * contents into intermediate header file.
 * Extracts the public key from cert request file and Wraps the encryption keys using
 * RSA public key and outputs wrapped keys and public key into intermediate header file.
 * Reads the intermediate headerfile for wrapped keys,RSA public key and encrypted
 * contents and decrypts into output file.
 *
 * How this sample is different from sample 4 ?
 *
 * 1. Generate same keys as sample 4, outputs public key as cert request.
 * 2. Like sample 4, except that it reads in public key from cert request file instead
 *    of looking it up by label name, and writes public key into header instead of a
 *    label name. Rest is the same.
 * 3. Like sample 4, except that it reads in RSA public key, and then finds matching
 *    private key (by key ID).  Rest is the same.
 */</span>
<span class="token keyword">int</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus           rv<span class="token punctuation">;</span>
    SECStatus           rvShutdown<span class="token punctuation">;</span>
    PLOptState          <span class="token operator">*</span>optstate<span class="token punctuation">;</span>
    PLOptStatus         status<span class="token punctuation">;</span>
    <span class="token keyword">char</span>                headerFileName<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span>                encryptedFileName<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    PK11SlotInfo        <span class="token operator">*</span>slot                <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRBool              ascii                <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span>
    CommandType         cmd                  <span class="token operator">=</span> UNKNOWN<span class="token punctuation">;</span>
    PRFileDesc          <span class="token operator">*</span>inFile              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PRFileDesc          <span class="token operator">*</span>outFile             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span>                <span class="token operator">*</span>subjectStr          <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    CERTName            <span class="token operator">*</span>subject             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span>          <span class="token operator">*</span>dbdir               <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span>          <span class="token operator">*</span>inFileName          <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span>          <span class="token operator">*</span>outFileName         <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span>          <span class="token operator">*</span>certReqFileName     <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span>          <span class="token operator">*</span>noiseFileName       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    secuPWData          pwdata               <span class="token operator">=</span> <span class="token punctuation">{</span> PW_NONE<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span> progName <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    progName <span class="token operator">=</span> progName <span class="token operator">?</span> progName <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/* Parse command line arguments */</span>
    optstate <span class="token operator">=</span> <span class="token function">PL_CreateOptState</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"c:d:i:o:f:p:z:a:s:r:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">PL_GetNextOpt</span><span class="token punctuation">(</span>optstate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> PL_OPT_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'a'</span><span class="token operator">:</span>
            ascii <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'c'</span><span class="token operator">:</span>
            cmd <span class="token operator">=</span> <span class="token function">option2Command</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'d'</span><span class="token operator">:</span>
            dbdir <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'f'</span><span class="token operator">:</span>
            pwdata<span class="token punctuation">.</span>source <span class="token operator">=</span> PW_FROMFILE<span class="token punctuation">;</span>
            pwdata<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'p'</span><span class="token operator">:</span>
            pwdata<span class="token punctuation">.</span>source <span class="token operator">=</span> PW_PLAINTEXT<span class="token punctuation">;</span>
            pwdata<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'i'</span><span class="token operator">:</span>
            inFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'o'</span><span class="token operator">:</span>
            outFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'r'</span><span class="token operator">:</span>
            certReqFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token operator">:</span>
            subjectStr  <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            subject     <span class="token operator">=</span> <span class="token function">CERT_AsciiToName</span><span class="token punctuation">(</span>subjectStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'z'</span><span class="token operator">:</span>
            noiseFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">PL_DestroyOptState</span><span class="token punctuation">(</span>optstate<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> UNKNOWN <span class="token operator">||</span> <span class="token operator">!</span>dbdir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* For intermediate header file, choose filename as inputfile name
       with extension ".header" */</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> <span class="token string">".header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* For intermediate encrypted file, choose filename as inputfile name
       with extension ".enc" */</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> <span class="token string">".enc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PR_Init</span><span class="token punctuation">(</span>PR_USER_THREAD<span class="token punctuation">,</span> PR_PRIORITY_NORMAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Open DB for read/write and authenticate to it. */</span>
    rv <span class="token operator">=</span> <span class="token function">NSS_InitReadWrite</span><span class="token punctuation">(</span>dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"NSS_InitReadWrite Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">PK11_SetPasswordFunc</span><span class="token punctuation">(</span>GetModulePassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    slot <span class="token operator">=</span> <span class="token function">PK11_GetInternalKeySlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not authenticate to token %s.\n"</span><span class="token punctuation">,</span>
                    <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> GEN_CSR<span class="token operator">:</span>

        <span class="token comment">/* Validate command for Generate CSR */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>certReqFileName <span class="token operator">||</span> <span class="token operator">!</span>subject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/*
         * Generate the cert request and save it
         * in a file so public key can be retrieved later to wrap the symmetric key
         */</span>
        rv <span class="token operator">=</span> <span class="token function">CreateCertificateRequest</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Create Certificate Request: Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ENCRYPT<span class="token operator">:</span>
        <span class="token comment">/* Validate command for Encrypt */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>certReqFileName <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * Read cert request from a file and extract public key
         * Generates an AES encryption key, session object
         * Generates a MAC key, session object
         * Wraps each of those keys with RSA public key
         * Write wrapped keys and public key into intermediate header file
         * Encryption and MACing loop
         * Destroy session keys
         * Close files
         */</span>
        rv <span class="token operator">=</span> <span class="token function">EncryptFile</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> inFileName<span class="token punctuation">,</span> certReqFileName<span class="token punctuation">,</span>
                         headerFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">,</span>
                         noiseFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"EncryptFile : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> DECRYPT<span class="token operator">:</span>
        <span class="token comment">/* Validate command for Decrypt */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFileName <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>outFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/*
         * Reads intermediate header including public key and wrapped keys
         * Finds RSA private key corresponding to the public key
         * unwraps two keys, creating session key objects
         * Decryption and MAC checking loop to write to output file
         * Destroy session keys
         * CLose files
         */</span>
        rv <span class="token operator">=</span> <span class="token function">DecryptFile</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span>
                  outFileName<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span>
                  encryptedFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"DecryptFile : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PK11_FreeSlot</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rvShutdown <span class="token operator">=</span> <span class="token function">NSS_Shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rvShutdown <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed : NSS_Shutdown()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">PR_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>