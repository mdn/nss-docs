<h1>Utilities for nss samples</h1><h2 id="nss_sample_code_0_utilities."><a href="#nss_sample_code_0_utilities." title="Permalink to NSS Sample Code 0: Utilities.">NSS Sample Code 0: Utilities.</a></h2><div><p class="summary">These utility functions are adapted from those found in the sectool library used by the NSS security tools and other NSS test applications.&nbsp;</p>

<p>It shows the following:</p>

<ul>
 <li>Read DER from a file.</li>
 <li>Compile file size.</li>
 <li>Get seed From a noise gile.</li>
 <li>Generate random numbers.</li>
 <li>Get a module password.</li>
 <li>Extract the password from a text file.</li>
 <li>Print data as hexadecimal.</li>
</ul></div><h3 id="util.h"><a href="#util.h" title="Permalink to util.h">util.h</a></h3><div><pre class="brush: cpp notranslate"><code><span class="token comment">/* This Source Code Form is subject to the terms of the Mozilla Public
* License, v. 2.0. If a copy of the MPL was not distributed with this
* file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_UTIL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">_UTIL_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;prlog.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;termios.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;base64.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;prprf.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;prerror.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;nss.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pk11func.h&gt;</span></span>

<span class="token comment">/*
* These utility functions are adapted from those found in
* the sectool library used by the NSS security tools and
* other NSS test applications.
*/</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">enum</span> <span class="token punctuation">{</span>
        PW_NONE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">/* no password */</span>
        PW_FROMFILE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">/* password stored in a file */</span>
        PW_PLAINTEXT <span class="token operator">=</span> <span class="token number">2</span>    <span class="token comment">/* plain-text password passed in  buffer */</span>
        <span class="token comment">/* PW_EXTERNAL = 3  */</span>
    <span class="token punctuation">}</span> source<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
    <span class="token comment">/* depending on source this can be the actual
     * password or the file to read it from
     */</span>
<span class="token punctuation">}</span> secuPWData<span class="token punctuation">;</span>

<span class="token comment">/*
 * PrintAsAscii
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span>
<span class="token function">PrintAsAscii</span><span class="token punctuation">(</span>PRFileDesc<span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * PrintAsHex
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span>
<span class="token function">PrintAsHex</span><span class="token punctuation">(</span>PRFileDesc<span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * GetDigit
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span>
<span class="token function">GetDigit</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * HexToBuf
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span>
<span class="token function">HexToBuf</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>inString<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>outbuf<span class="token punctuation">,</span> PRBool isHexData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * FileToItem
 */</span>
<span class="token keyword">extern</span> SECStatus
<span class="token function">FileToItem</span><span class="token punctuation">(</span>SECItem <span class="token operator">*</span>dst<span class="token punctuation">,</span> PRFileDesc <span class="token operator">*</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * CheckPassword
 */</span>
<span class="token keyword">extern</span> PRBool
<span class="token function">CheckPassword</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * GetPassword
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span>
<span class="token function">GetPassword</span><span class="token punctuation">(</span>FILE   <span class="token operator">*</span>input<span class="token punctuation">,</span>
            FILE   <span class="token operator">*</span>output<span class="token punctuation">,</span>
            <span class="token keyword">char</span>   <span class="token operator">*</span>prompt<span class="token punctuation">,</span>
            <span class="token function">PRBool</span> <span class="token punctuation">(</span><span class="token operator">*</span>ok<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * FilePasswd extracts the password from a text file
 *
 * Storing passwords is often used with server environments
 * where prompting the user for a password or requiring it
 * to be entered in the commnd line is not a feasible option.
 *
 * This function supports password extraction from files with
 * multipe passwords, one for each token. In the single password
 * case a line would just have the passord whereas in the multi-
 * password variant they could be of the form
 *
 * token_1_name:its_password
 * token_2_name:its_password
 *
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span>
<span class="token function">FilePasswd</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>
           slot<span class="token punctuation">,</span> PRBool retry<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * GetModulePassword
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span>
<span class="token function">GetModulePassword</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span>
                  <span class="token keyword">int</span>          retry<span class="token punctuation">,</span>
                  <span class="token keyword">void</span>         <span class="token operator">*</span>pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * GenerateRandom
 */</span>
<span class="token keyword">extern</span> SECStatus
<span class="token function">GenerateRandom</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>rbuf<span class="token punctuation">,</span>
               <span class="token keyword">int</span>           rsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * FileToItem
 */</span>
<span class="token keyword">extern</span> SECStatus
<span class="token function">FileToItem</span><span class="token punctuation">(</span>SECItem    <span class="token operator">*</span>dst<span class="token punctuation">,</span>
           PRFileDesc <span class="token operator">*</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * SeedFromNoiseFile
 */</span>
<span class="token keyword">extern</span> SECStatus
<span class="token function">SeedFromNoiseFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>noiseFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * FileSize
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">long</span>
<span class="token function">FileSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * ReadDERFromFile
 */</span>
<span class="token keyword">extern</span> SECStatus
<span class="token function">ReadDERFromFile</span><span class="token punctuation">(</span>SECItem <span class="token operator">*</span>der<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* _UTIL_H */</span></span></code></pre></div><h3 id="util.c"><a href="#util.c" title="Permalink to Util.c">Util.c</a></h3><div><pre class="brush: cpp notranslate"><code><span class="token comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.h"</span></span>

<span class="token comment">/*
 * These utility functions are adapted from those found in
 * the sectool library used by the NSS security tools and
 * other NSS test applications.
 */</span>

<span class="token comment">/*
 * Newline
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">Newline</span><span class="token punctuation">(</span>PRFileDesc<span class="token operator">*</span> out<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * PrintAsAscii
 */</span>
<span class="token keyword">void</span>
<span class="token function">PrintAsAscii</span><span class="token punctuation">(</span>PRFileDesc<span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>b64Data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    b64Data <span class="token operator">=</span> <span class="token function">BTOA_DataToAscii</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> b64Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b64Data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PORT_Free</span><span class="token punctuation">(</span>b64Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * PrintAsHex
 */</span>
<span class="token keyword">void</span>
<span class="token function">PrintAsHex</span><span class="token punctuation">(</span>PRFileDesc<span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> column<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> level  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    column <span class="token operator">=</span> level<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token string">"(empty)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token string">"%02x:"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            column <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token string">"%02x"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            column <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>column <span class="token operator">&gt;</span> <span class="token number">76</span> <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> limit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Newline</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
            column <span class="token operator">=</span> level<span class="token punctuation">;</span>
            limit <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>column <span class="token operator">!=</span> level<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Newline</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * GetDigit
 */</span>
<span class="token keyword">int</span>
<span class="token function">GetDigit</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> <span class="token string">'9'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&gt;=</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> c <span class="token operator">-</span> <span class="token string">'0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> <span class="token string">'f'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&gt;=</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> c <span class="token operator">-</span> <span class="token string">'a'</span> <span class="token operator">+</span> <span class="token number">0xa</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> <span class="token string">'F'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&gt;=</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> c <span class="token operator">-</span> <span class="token string">'A'</span> <span class="token operator">+</span> <span class="token number">0xa</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * HexToBuf
 */</span>
<span class="token keyword">int</span>
<span class="token function">HexToBuf</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>inString<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>outbuf<span class="token punctuation">,</span> PRBool isHexData<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>inString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> outLen <span class="token operator">=</span> len<span class="token operator">+</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> trueLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> digit1<span class="token punctuation">,</span> digit2<span class="token punctuation">;</span>

    outbuf<span class="token operator">-&gt;</span>data <span class="token operator">=</span> isHexData
        <span class="token operator">?</span> <span class="token function">PORT_Alloc</span><span class="token punctuation">(</span>outLen<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">PORT_Alloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outbuf<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isHexData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>inString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>inString <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>inString <span class="token operator">==</span> <span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 inString<span class="token operator">++</span><span class="token punctuation">;</span>
                 <span class="token keyword">continue</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             digit1 <span class="token operator">=</span> <span class="token function">GetDigit</span><span class="token punctuation">(</span><span class="token operator">*</span>inString<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             digit2 <span class="token operator">=</span> <span class="token function">GetDigit</span><span class="token punctuation">(</span><span class="token operator">*</span>inString<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>digit1 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>digit2 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token function">PORT_Free</span><span class="token punctuation">(</span>outbuf<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 outbuf<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                 <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             outbuf<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>trueLen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> digit1 <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">|</span> digit2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>inString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>inString <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                inString<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            outbuf<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>trueLen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>inString<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        outbuf<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>trueLen<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        trueLen <span class="token operator">=</span> trueLen<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    outbuf<span class="token operator">-&gt;</span>len <span class="token operator">=</span> trueLen<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * FileToItem
 */</span>
SECStatus
<span class="token function">FileToItem</span><span class="token punctuation">(</span>SECItem <span class="token operator">*</span>dst<span class="token punctuation">,</span> PRFileDesc <span class="token operator">*</span>src<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PRFileInfo info<span class="token punctuation">;</span>
    PRInt32 numBytes<span class="token punctuation">;</span>
    PRStatus prStatus<span class="token punctuation">;</span>

    prStatus <span class="token operator">=</span> <span class="token function">PR_GetOpenFileInfo</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>prStatus <span class="token operator">!=</span> PR_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    dst<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SECITEM_AllocItem</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> dst<span class="token punctuation">,</span> info<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        numBytes <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> info<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">==</span> info<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> PR_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dst<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * echoOff
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">echoOff</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">struct</span> <span class="token class-name">termios</span> tio<span class="token punctuation">;</span>
       <span class="token function">tcgetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tio<span class="token punctuation">)</span><span class="token punctuation">;</span>
       tio<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;=</span> <span class="token operator">~</span>ECHO<span class="token punctuation">;</span>
       <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSAFLUSH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tio<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * echoOn
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">echoOn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">struct</span> <span class="token class-name">termios</span> tio<span class="token punctuation">;</span>
       <span class="token function">tcgetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tio<span class="token punctuation">)</span><span class="token punctuation">;</span>
       tio<span class="token punctuation">.</span>c_lflag <span class="token operator">|=</span> ECHO<span class="token punctuation">;</span>
       <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSAFLUSH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tio<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * CheckPassword
 */</span>
PRBool <span class="token function">CheckPassword</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>end<span class="token punctuation">;</span>
    len <span class="token operator">=</span> <span class="token function">PORT_Strlen</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> PR_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    end <span class="token operator">=</span> cp <span class="token operator">+</span> len<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cp <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ch <span class="token operator">=</span> <span class="token operator">*</span>cp<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">&gt;=</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ch <span class="token operator">&lt;=</span> <span class="token string">'Z'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">&gt;=</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ch <span class="token operator">&lt;=</span> <span class="token string">'z'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> PR_TRUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> PR_FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * GetPassword
 */</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetPassword</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>input<span class="token punctuation">,</span> FILE <span class="token operator">*</span>output<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>prompt<span class="token punctuation">,</span>
                  <span class="token function">PRBool</span> <span class="token punctuation">(</span><span class="token operator">*</span>ok<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> phrase<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'\0'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> infd         <span class="token operator">=</span> <span class="token function">fileno</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> isTTY        <span class="token operator">=</span> <span class="token function">isatty</span><span class="token punctuation">(</span>infd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Prompt for password */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isTTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span> <span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">echoOff</span><span class="token punctuation">(</span>infd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>phrase<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isTTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">echoOn</span><span class="token punctuation">(</span>infd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* stomp on newline */</span>
        phrase<span class="token punctuation">[</span><span class="token function">PORT_Strlen</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">/* Validate password */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ok<span class="token punctuation">)</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isTTY<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">"Password must be at least 8 characters long with one or more\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">"non-alphabetic characters\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">PORT_Strdup</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * FilePasswd extracts the password from a text file
 *
 * Storing passwords is often used with server environments
 * where prompting the user for a password or requiring it
 * to be entered in the commnd line is not a feasible option.
 *
 * This function supports password extraction from files with
 * multipe passwords, one for each token. In the single password
 * case a line would just have the passord whereas in the multi-
 * password variant they could be of the form
 *
 * token_1_name:its_password
 * token_2_name:its_password
 *
 */</span>
<span class="token keyword">char</span> <span class="token operator">*</span>
<span class="token function">FilePasswd</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> PRBool retry<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> phrases<span class="token punctuation">,</span> <span class="token operator">*</span>phrase<span class="token punctuation">;</span>
    PRFileDesc <span class="token operator">*</span>fd<span class="token punctuation">;</span>
    PRInt32 nb<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>pwFile <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">long</span> maxPwdFileSize <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> tokenName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tokenLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pwFile<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">/* no good retrying - the files contents will be the same */</span>
    <span class="token punctuation">}</span>

    phrases <span class="token operator">=</span> <span class="token function">PORT_ZAlloc</span><span class="token punctuation">(</span>maxPwdFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>phrases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* out of memory */</span>
    <span class="token punctuation">}</span>

    fd <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>pwFile<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"No password file \"%s\" exists.\n"</span><span class="token punctuation">,</span> pwFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PORT_Free</span><span class="token punctuation">(</span>phrases<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nb <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> phrases<span class="token punctuation">,</span> maxPwdFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PR_Close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nb <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"password file contains no data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PORT_Free</span><span class="token punctuation">(</span>phrases<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tokenName <span class="token operator">=</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tokenName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tokenLen <span class="token operator">=</span> <span class="token function">PORT_Strlen</span><span class="token punctuation">(</span>tokenName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> startphrase <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token keyword">int</span> phraseLen<span class="token punctuation">;</span>

        <span class="token comment">/* handle the Windows EOL case */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>phrases<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\r'</span> <span class="token operator">&amp;&amp;</span> phrases<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\n'</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> nb<span class="token punctuation">)</span> i<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">/* terminate passphrase */</span>
        phrases<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token comment">/* clean up any EOL before the start of the next passphrase */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>phrases<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\r'</span> <span class="token operator">||</span> phrases<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            phrases<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* now analyze the current passphrase */</span>
        phrase <span class="token operator">=</span> <span class="token operator">&amp;</span>phrases<span class="token punctuation">[</span>startphrase<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokenName<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PORT_Strncmp</span><span class="token punctuation">(</span>phrase<span class="token punctuation">,</span> tokenName<span class="token punctuation">,</span> tokenLen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        phraseLen <span class="token operator">=</span> <span class="token function">PORT_Strlen</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>phraseLen <span class="token operator">&lt;</span> <span class="token punctuation">(</span>tokenLen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>phrase<span class="token punctuation">[</span>tokenLen<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">':'</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        phrase <span class="token operator">=</span> <span class="token operator">&amp;</span>phrase<span class="token punctuation">[</span>tokenLen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    phrase <span class="token operator">=</span> <span class="token function">PORT_Strdup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>phrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PORT_Free</span><span class="token punctuation">(</span>phrases<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> phrase<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * GetModulePassword
 */</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetModulePassword</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> <span class="token keyword">int</span> retry<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> prompt<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    secuPWData <span class="token operator">*</span>pwdata <span class="token operator">=</span> <span class="token punctuation">(</span>secuPWData <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>pw<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pwdata <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>retry <span class="token operator">&amp;&amp;</span> pwdata<span class="token operator">-&gt;</span>source <span class="token operator">!=</span> PW_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Incorrect password/PIN entered.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pwdata<span class="token operator">-&gt;</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> PW_NONE<span class="token operator">:</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> <span class="token string">"Enter Password or Pin for \"%s\":"</span><span class="token punctuation">,</span>
                <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">GetPassword</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">,</span> prompt<span class="token punctuation">,</span> CheckPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> PW_FROMFILE<span class="token operator">:</span>
        pw <span class="token operator">=</span> <span class="token function">FilePasswd</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> retry<span class="token punctuation">,</span> pwdata<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pwdata<span class="token operator">-&gt;</span>source <span class="token operator">=</span> PW_PLAINTEXT<span class="token punctuation">;</span>
        pwdata<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token function">PL_strdup</span><span class="token punctuation">(</span>pw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pw<span class="token punctuation">;</span>
    <span class="token keyword">case</span> PW_PLAINTEXT<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">PL_strdup</span><span class="token punctuation">(</span>pwdata<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Password check failed:  No password found.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * GenerateRandom
 */</span>
SECStatus
<span class="token function">GenerateRandom</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>rbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> rsize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> meter<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                   <span class="token string">"\r|                                |"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>            fd<span class="token punctuation">,</span>  count<span class="token punctuation">;</span>
    <span class="token keyword">int</span>            c<span class="token punctuation">;</span>
    SECStatus      rv                  <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span>
    cc_t           orig_cc_min<span class="token punctuation">;</span>
    cc_t           orig_cc_time<span class="token punctuation">;</span>
    tcflag_t       orig_lflag<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">termios</span> tio<span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"To generate random numbers, "</span>
            <span class="token string">"continue typing until the progress meter is full:\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> meter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\r|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* turn off echo on stdin &amp; return on 1 char instead of NL */</span>
    fd <span class="token operator">=</span> <span class="token function">fileno</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">tcgetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    orig_lflag <span class="token operator">=</span> tio<span class="token punctuation">.</span>c_lflag<span class="token punctuation">;</span>
    orig_cc_min <span class="token operator">=</span> tio<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span>VMIN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    orig_cc_time <span class="token operator">=</span> tio<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span>VTIME<span class="token punctuation">]</span><span class="token punctuation">;</span>
    tio<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;=</span> <span class="token operator">~</span>ECHO<span class="token punctuation">;</span>
    tio<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;=</span> <span class="token operator">~</span>ICANON<span class="token punctuation">;</span>
    tio<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span>VMIN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    tio<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span>VTIME<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSAFLUSH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Get random noise from keyboard strokes */</span>
    count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> rsize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>rbuf <span class="token operator">+</span> count<span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> c <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span>rbuf <span class="token operator">+</span> count <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    rbuf<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\n\nFinished.  Press enter to continue: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'\n'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* set back termio the way it was */</span>
    tio<span class="token punctuation">.</span>c_lflag <span class="token operator">=</span> orig_lflag<span class="token punctuation">;</span>
    tio<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span>VMIN<span class="token punctuation">]</span> <span class="token operator">=</span> orig_cc_min<span class="token punctuation">;</span>
    tio<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span>VTIME<span class="token punctuation">]</span> <span class="token operator">=</span> orig_cc_time<span class="token punctuation">;</span>
    <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSAFLUSH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * SeedFromNoiseFile
 */</span>
SECStatus
<span class="token function">SeedFromNoiseFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>noiseFileName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    PRFileDesc <span class="token operator">*</span>fd<span class="token punctuation">;</span>
    PRInt32 count<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>noiseFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"failed to open noise file."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        count <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PK11_RandomUpdate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PR_Close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * FileSize
 */</span>
<span class="token keyword">long</span> <span class="token function">FileSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> stbuf<span class="token punctuation">;</span>
    <span class="token function">stat</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stbuf<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 *  ReadDERFromFile
 */</span>
SECStatus
<span class="token function">ReadDERFromFile</span><span class="token punctuation">(</span>SECItem <span class="token operator">*</span>der<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SECStatus rv       <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span>
    PRFileDesc <span class="token operator">*</span>inFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to open file \"%s\" (%ld, %ld).\n"</span><span class="token punctuation">,</span>
                   inFileName<span class="token punctuation">,</span> <span class="token function">PR_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PR_GetOSError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* First convert ascii to binary */</span>
        SECItem filedata<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>asc<span class="token punctuation">,</span> <span class="token operator">*</span>body<span class="token punctuation">;</span>

        <span class="token comment">/* Read in ascii data */</span>
        rv <span class="token operator">=</span> <span class="token function">FileToItem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filedata<span class="token punctuation">,</span> inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        asc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to read data from input file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* check for headers and trailers and remove them */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>body <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>asc<span class="token punctuation">,</span> <span class="token string">"-----BEGIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>trailer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            asc <span class="token operator">=</span> body<span class="token punctuation">;</span>
            body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">)</span>
                body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>asc<span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* maybe this is a MAC file */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span>
                trailer <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token operator">++</span>body<span class="token punctuation">,</span> <span class="token string">"-----END"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>trailer <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>trailer <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>  <span class="token string">"input has header but no trailer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            body <span class="token operator">=</span> asc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Convert to binary */</span>
        rv <span class="token operator">=</span> <span class="token function">ATOB_ConvertAsciiToItem</span><span class="token punctuation">(</span>der<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span>  <span class="token string">"error converting ascii to binary %s\n"</span><span class="token punctuation">,</span>
                       <span class="token function">PORT_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Read in binary der */</span>
        rv <span class="token operator">=</span> <span class="token function">FileToItem</span><span class="token punctuation">(</span>der<span class="token punctuation">,</span> inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"error converting der \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
cleanup<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PR_Close</span><span class="token punctuation">(</span>inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rv<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>