<!DOCTYPE html><html><head><meta charset="utf-8"><title>NSS Sample Code sample5 - Mozilla | MDN</title></head><body><main><article class="main-page-content" lang="en-US"><h1>NSS Sample Code sample5</h1><h2 id="nss_sample_code_5_pki_encryption_with_a_raw_public_private_key_in_der_format"><a href="#nss_sample_code_5_pki_encryption_with_a_raw_public_private_key_in_der_format" title="Permalink to NSS Sample Code 5: PKI Encryption with a raw public &amp; private key in DER format">NSS Sample Code 5: PKI Encryption with a raw public &amp; private key in DER format</a></h2><div><pre class="notranslate">/* Example code to illustrate PKI crypto ops (encrypt with public key,
 * decrypt with private key)
 *
 * No NSS db needed. The Public Key &amp; Private Key to use are
 * sourced from a base64-encoded DER SubjectPublicKeyInfo structure,
 * and a base64-encoded DER PrivateKeyInfo structure.
 *
 * There is no attempt to link the public &amp; private key together
 *
 * This example does not do any padding. It simply encrypts/decrypts a block
 * of length equal to modulus length of the public/private key.
 */


#include "nss.h"
#include "pk11pub.h"

#define BASE64_ENCODED_SUBJECTPUBLICKEYINFO "MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAL3F6TIc3JEYsugo+a2fPU3W+Epv/FeIX21DC86WYnpFtW4srFtz2oNUzyLUzDHZdb+k//8dcT3IAOzUUi3R2eMCAwEAAQ=="

#define BASE64_ENCODED_PRIVATEKEYINFO "MIIBVQIBADANBgkqhkiG9w0BAQEFAASCAT8wggE7AgEAAkEAvcXpMhzckRiy6Cj5rZ89Tdb4Sm/8V4hfbUMLzpZiekW1biysW3Pag1TPItTMMdl1v6T//x1xPcgA7NRSLdHZ4wIDAQABAkEAjh8+4qncwcmGivnM6ytbpQT+k/jEOeXG2bQhjojvnXN3FazGCEFXvpuIBcJVfaIJS9YBCMOzzrAtO0+k2hWnOQIhAOC4NVbo8FQhZS4yXM1M86kMl47FA9ui//OUfbhlAdw1AiEA2DBmIXnsboKB+OHver69p0gNeWlvcJc9bjDVfdLVsLcCIQCPtV3vGYJv2vdwxqZQaHC+YB4gIGAqOqBCbmjD3lyFLQIgA+VTYdUNoqwtZWvE4gRf7IzK2V5CCNhg3gR5RGwxN58CIGCcafoRrUKsM66ISg0ITI04G9V/w+wMx91wjEEB+QBz"


int main(int argc, char **argv)
{
  SECStatus          rv;
  CERTCertificate   *cert = NULL;
  SECKEYPublicKey   *pubkey = NULL;
  CERTSubjectPublicKeyInfo *spki = NULL;
  SECKEYPrivateKey  *pvtkey = NULL;
  int                modulus_len, i, outlen;
  char              *buf1 = NULL;
  char              *buf2 = NULL;
  char              *pubkstr = BASE64_ENCODED_SUBJECTPUBLICKEYINFO;
  char              *pvtkstr = BASE64_ENCODED_PRIVATEKEYINFO;
  SECItem            der;
  SECItem            nickname;
  PK11SlotInfo      *slot = NULL;

  /* Initialize NSS
   * You need to explicitly authenticate to the internal token if you use
   * NSS_Init insteadf of NSS_NoDB_Init
   * Invoke this after getting the internal token handle
   *      PK11_Authenticate(slot, PR_FALSE, NULL);
   */
  rv = NSS_NoDB_Init(".");
  if (rv != SECSuccess)
  {
    fprintf(stderr, "NSS initialization failed (err %d)\n",
            PR_GetError());
    goto cleanup;
  }

  /* get internal slot */
  slot = PK11_GetInternalKeySlot();
  if (slot == NULL)
  {
    fprintf(stderr, "Couldn't find slot (err %d)\n", PR_GetError());
    goto cleanup;
  }

  rv = ATOB_ConvertAsciiToItem(&amp;der, pubkstr);
  if (rv!= SECSuccess)
  {
    fprintf(stderr, "ATOB_ConvertAsciiToItem failed %d\n", PR_GetError());
    goto cleanup;
  }
  spki = SECKEY_DecodeDERSubjectPublicKeyInfo(&amp;der);
  SECITEM_FreeItem(&amp;der, PR_FALSE);
  pubkey = SECKEY_ExtractPublicKey(spki);

  if (pubkey == NULL)
  {
    fprintf(stderr, "Couldn't extract public key (err %d)\n", PR_GetError());
    goto cleanup;
  }

  modulus_len = SECKEY_PublicKeyStrength(pubkey);
  fprintf(stderr, "Public Key Modulus %d bytes\n", modulus_len);
  buf1 = (char *)malloc(modulus_len);
  buf2 = (char *)malloc(modulus_len);

  /* initialize buf1 */
  for (i=0;i&lt;modulus_len;i++)
  {
    buf1[i]= (i %26) + 'A';
  }
  buf1[modulus_len-1] = '\0';
  fprintf(stderr, "Buffer being encrypted = \n%s\n", buf1);

  /* encrypt buf1, result will be in buf2 */
  rv = PK11_PubEncryptRaw(pubkey, buf2, buf1, modulus_len, NULL);
  if (rv != SECSuccess)
  {
    fprintf(stderr, "Encrypt with Public Key failed (err %d)\n",
            PR_GetError());
    goto cleanup;
  }

  nickname.type = siBuffer;
  nickname.data = "pvtkeynickname";
  nickname.len = strlen("pvtkeynickname");
  rv = ATOB_ConvertAsciiToItem(&amp;der, pvtkstr);
  if (rv!= SECSuccess)
  {
    fprintf(stderr, "ATOB_ConvertAsciiToItem failed %d\n", PR_GetError());
    goto cleanup;
  }

  /* KU_ALL includes a lot of different key usages, KU_DATA_ENCIPHERMENT
   * is enough for just RSA encryption.
   * publicValue arg (4th) can be NULL for RSA key - I think it is even
   * ignored
   */
  PK11_ImportDERPrivateKeyInfoAndReturnKey(slot, &amp;der, NULL,
                                           NULL, PR_FALSE, PR_TRUE,
                                           KU_ALL, &amp;pvtkey, NULL);
  SECITEM_FreeItem(&amp;der, PR_FALSE);

  if (pvtkey == NULL)
  {
    fprintf(stderr, "Couldn't extract private key (err %d)\n", PR_GetError());
    goto cleanup;
  }

  /* clear buf1 */
  for (i=0;i&lt;modulus_len;i++)
  {
    buf1[i]= '\0';
  }

  /* decrypt buf2, result will be in buf1 */
  rv = PK11_PubDecryptRaw(pvtkey, buf1, &amp;outlen, modulus_len, buf2,
                          modulus_len);
  if (rv != SECSuccess)
  {
    fprintf(stderr, "Decrypt with Private Key failed (err %d)\n",
            PR_GetError());
    goto cleanup;
  }

  fprintf(stderr, "Result of decryption, outlen = %d\n", outlen);
  fprintf(stderr, "Result of decryption, buf = \n%s\n", buf1);

cleanup:
  if (cert)
    CERT_DestroyCertificate(cert);
  if (pubkey)
    SECKEY_DestroyPublicKey(pubkey);
  if (pvtkey)
    SECKEY_DestroyPrivateKey(pvtkey);
  if (spki)
    SECKEY_DestroySubjectPublicKeyInfo(spki);
  if (slot)
    PK11_FreeSlot(slot);
  if (buf1)
    free(buf1);
  if (buf2)
    free(buf2);
  exit(1);
}
</pre></div></article><aside class="metadata"><div class="metadata-content-container"><div id="on-github" class="on-github"><h4>Found a problem with this page?</h4><ul><li><a href="https://github.com/mdn/content/blob/main/files/en-us/mozilla/projects/nss/nss_sample_code/nss_sample_code_sample5/index.html" title="Folder: en-us/mozilla/projects/nss/nss_sample_code/nss_sample_code_sample5 (Opens in a new tab)" target="_blank" rel="noopener noreferrer">Source on <b>GitHub</b></a></li><li><a href="https://github.com/mdn/content/issues/new?body=MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FMozilla%2FProjects%2FNSS%2FNSS_Sample_Code%2FNSS_Sample_Code_sample5%0A%0A%23%23%23%23+What+information+was+incorrect%2C+unhelpful%2C+or+incomplete%3F%0A%0A%0A%23%23%23%23+Specific+section+or+headline%3F%0A%0A%0A%23%23%23%23+What+did+you+expect+to+see%3F%0A%0A%0A%23%23%23%23+Did+you+test+this%3F+If+so%2C+how%3F%0A%0A%0A%3C%21--+Do+not+make+changes+below+this+line+--%3E%0A%3Cdetails%3E%0A%3Csummary%3EMDN+Content+page+report+details%3C%2Fsummary%3E%0A%0A*+Folder%3A+%60en-us%2Fmozilla%2Fprojects%2Fnss%2Fnss_sample_code%2Fnss_sample_code_sample5%60%0A*+MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FMozilla%2FProjects%2FNSS%2FNSS_Sample_Code%2FNSS_Sample_Code_sample5%0A*+GitHub+URL%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fblob%2Fmain%2Ffiles%2Fen-us%2Fmozilla%2Fprojects%2Fnss%2Fnss_sample_code%2Fnss_sample_code_sample5%2Findex.html%0A*+Last+commit%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fcommit%2Fc562f18870c7d1e06aa2b338ecbe93e3fd890a7b%0A*+Document+last+modified%3A+2020-12-22T07%3A08%3A04.000Z%0A%0A%3C%2Fdetails%3E&amp;title=Issue+with+%22NSS+Sample+Code+sample5%22%3A+%28short+summary+here+please%29&amp;labels=Content%3AOther%2Cneeds-triage" title="This will take you to https://github.com/mdn/content to file a new issue" target="_blank" rel="noopener noreferrer">Report a problem with this content on <b>GitHub</b></a></li><li>Want to fix the problem yourself? See<!-- --> <a href="https://github.com/mdn/content/blob/main/README.md" target="_blank" rel="noopener noreferrer">our Contribution guide</a>.</li></ul></div><p class="last-modified-date"><b>Last modified:</b> <time datetime="2020-12-22T07:08:04.000Z">Dec 21, 2020</time>,<!-- --> <a href="/en-US/docs/Mozilla/Projects/NSS/NSS_Sample_Code/NSS_Sample_Code_sample5/contributors.txt">by MDN contributors</a></p></div></aside></main></body></html>