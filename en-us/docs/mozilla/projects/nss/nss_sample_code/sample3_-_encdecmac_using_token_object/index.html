<h1>EncDecMAC using token object - sample 3</h1><h2 id="encdecmac_using_token_object"><a href="#encdecmac_using_token_object" title="Permalink to EncDecMAC using token object">EncDecMAC using token object</a></h2><div></div><h3 id="example"><a href="#example" title="Permalink to Example:">Example:</a></h3><div></div><h2 id="nss_sample_code_3_hashing."><a href="#nss_sample_code_3_hashing." title="Permalink to NSS Sample Code 3: Enc/Dec/MAC Using Token Object ID.">NSS Sample Code 3: Enc/Dec/MAC Using Token Object ID.</a></h2><div><p class="summary">Computes the hash of a file and saves it to another file, illustrates the use of NSS message APIs.</p>

<pre class="brush: cpp notranslate"><code><span class="token comment">/* This Source Code Form is subject to the terms of the Mozilla Public * License, v. 2.0. If a copy of the MPL was not distributed with this * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span> <span class="token comment">/* NSPR Headers */</span> #include #include #include #include #include #include #include <span class="token comment">/* NSS headers */</span> #include #include <span class="token comment">/* our samples utilities */</span> #include <span class="token string">"util.h"</span> #define BUFFERSIZE <span class="token number">80</span> #define DIGESTSIZE <span class="token number">16</span> #define PTEXT_MAC_BUFFER_SIZE <span class="token number">96</span> #define CIPHERSIZE <span class="token number">96</span> #define BLOCKSIZE <span class="token number">32</span> #define CIPHER_HEADER <span class="token string">"-----BEGIN CIPHER-----"</span> #define CIPHER_TRAILER <span class="token string">"-----END CIPHER-----"</span> #define ENCKEY_HEADER <span class="token string">"-----BEGIN AESKEY CKAID-----"</span> #define ENCKEY_TRAILER <span class="token string">"-----END AESKEY CKAID-----"</span> #define MACKEY_HEADER <span class="token string">"-----BEGIN MACKEY CKAID-----"</span> #define MACKEY_TRAILER <span class="token string">"-----END MACKEY CKAID-----"</span> #define IV_HEADER <span class="token string">"-----BEGIN IV-----"</span> #define IV_TRAILER <span class="token string">"-----END IV-----"</span> #define MAC_HEADER <span class="token string">"-----BEGIN MAC-----"</span> #define MAC_TRAILER <span class="token string">"-----END MAC-----"</span> #define PAD_HEADER <span class="token string">"-----BEGIN PAD-----"</span> #define PAD_TRAILER <span class="token string">"-----END PAD-----"</span> <span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> ENCRYPT<span class="token punctuation">,</span> DECRYPT<span class="token punctuation">,</span> UNKNOWN <span class="token punctuation">}</span> CommandType<span class="token punctuation">;</span> <span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> SYMKEY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> MACKEY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> IV <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> MAC <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> PAD <span class="token operator">=</span> <span class="token number">4</span> <span class="token punctuation">}</span> HeaderType<span class="token punctuation">;</span> <span class="token comment">/* * Print usage message and exit */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Usage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nUsage: %s -c -d [-z ] "</span> <span class="token string">"[-p | -f ] -i -o \n\n"</span><span class="token punctuation">,</span> progName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s Specify 'a' for encrypt operation\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-c "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s Specify 'b' for decrypt operation\n\n"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s Specify db directory path\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-d "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s Specify db password [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-p "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s Specify db password file [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-f "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-20s Specify noise file name [optional]\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-z "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-21s Specify an input file name\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-i "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-21s Specify an output file name\n\n"</span><span class="token punctuation">,</span> <span class="token string">"-o "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s For encrypt, it takes as an input file and produces\n"</span><span class="token punctuation">,</span> <span class="token string">"Note :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s .enc and .header as intermediate output files.\n\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s For decrypt, it takes .enc and .header\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%-7s as input files and produces as a final output file.\n\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Gather a CKA_ID */</span> SECStatus <span class="token function">GatherCKA_ID</span><span class="token punctuation">(</span>PK11SymKey<span class="token operator">*</span> key<span class="token punctuation">,</span> SECItem<span class="token operator">*</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> <span class="token function">PK11_ReadRawAttribute</span><span class="token punctuation">(</span>PK11_TypeSymKey<span class="token punctuation">,</span> key<span class="token punctuation">,</span> CKA_ID<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"PK11_ReadRawAttribute returned (%d)\n"</span><span class="token punctuation">,</span> rv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not read SymKey CKA_ID attribute\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Generate a Symmetric Key */</span> PK11SymKey <span class="token operator">*</span> <span class="token function">GenerateSYMKey</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> CK_MECHANISM_TYPE mechanism<span class="token punctuation">,</span> <span class="token keyword">int</span> keySize<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>keyID<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PK11SymKey <span class="token operator">*</span>key<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PK11_NeedLogin</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not authenticate to token %s.\n"</span><span class="token punctuation">,</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">/* Generate the symmetric key */</span> key <span class="token operator">=</span> <span class="token function">PK11_TokenKeyGen</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> mechanism<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> keySize<span class="token punctuation">,</span> keyID<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Symmetric Key Generation Failed \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> key<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * MacInit */</span> SECStatus <span class="token function">MacInit</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> <span class="token function">PK11_DigestBegin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Compute MAC Failed : PK11_DigestBegin()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * MacUpdate */</span> SECStatus <span class="token function">MacUpdate</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> msgLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> <span class="token function">PK11_DigestOp</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Compute MAC Failed : DigestOp()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Finalize MACing */</span> SECStatus <span class="token function">MacFinal</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>mac<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>macLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> <span class="token function">PK11_DigestFinal</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> mac<span class="token punctuation">,</span> macLen<span class="token punctuation">,</span> maxLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Compute MAC Failed : PK11_DigestFinal()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Compute Mac */</span> SECStatus <span class="token function">ComputeMac</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctxmac<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptext<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ptextLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>mac<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>macLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv <span class="token operator">=</span> <span class="token function">MacInit</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">MacUpdate</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> ptextLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">MacFinal</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> mac<span class="token punctuation">,</span> macLen<span class="token punctuation">,</span> maxLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * WriteToHeaderFile */</span> SECStatus <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> HeaderType type<span class="token punctuation">,</span> PRFileDesc <span class="token operator">*</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> <span class="token keyword">char</span> header<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">char</span> trailer<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>outString <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> SYMKEY<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> ENCKEY_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> ENCKEY_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MACKEY<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> MACKEY_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> MACKEY_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> IV<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> IV_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> IV_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MAC<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> MAC_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> MAC_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> PAD<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> PAD_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> PAD_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PrintAsHex</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%s\n\n"</span><span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Initialize for encryption or decryption - common code */</span> PK11Context <span class="token operator">*</span> <span class="token function">CryptInit</span><span class="token punctuation">(</span>PK11SymKey <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span> CK_MECHANISM_TYPE type<span class="token punctuation">,</span> CK_ATTRIBUTE_TYPE operation<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECItem ivItem <span class="token operator">=</span> <span class="token punctuation">{</span> siBuffer<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen <span class="token punctuation">}</span><span class="token punctuation">;</span> PK11Context <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem <span class="token operator">*</span>secParam <span class="token operator">=</span> <span class="token function">PK11_ParamFromIV</span><span class="token punctuation">(</span>CKM_AES_CBC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ivItem<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>secParam <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Crypt Failed : secParam NULL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> ctx <span class="token operator">=</span> <span class="token function">PK11_CreateContextBySymKey</span><span class="token punctuation">(</span>CKM_AES_CBC<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> key<span class="token punctuation">,</span> secParam<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Crypt Failed : can't create a context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>secParam<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SECITEM_FreeItem</span><span class="token punctuation">(</span>secParam<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> ctx<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Common encryption and decryption code */</span> SECStatus <span class="token function">Crypt</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxOut<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">PK11_CipherOp</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> outLen<span class="token punctuation">,</span> maxOut<span class="token punctuation">,</span> in<span class="token punctuation">,</span> inLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Crypt Failed : PK11_CipherOp returned %d\n"</span><span class="token punctuation">,</span> rv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Decrypt */</span> SECStatus <span class="token function">Decrypt</span><span class="token punctuation">(</span>PK11Context <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxout<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Crypt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> outLen<span class="token punctuation">,</span> maxout<span class="token punctuation">,</span> in<span class="token punctuation">,</span> inLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Encrypt */</span> SECStatus <span class="token function">Encrypt</span><span class="token punctuation">(</span>PK11Context<span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>outLen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxout<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Crypt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> outLen<span class="token punctuation">,</span> maxout<span class="token punctuation">,</span> in<span class="token punctuation">,</span> inLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * EncryptInit */</span> PK11Context <span class="token operator">*</span> <span class="token function">EncryptInit</span><span class="token punctuation">(</span>PK11SymKey <span class="token operator">*</span>ek<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span> CK_MECHANISM_TYPE type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">CryptInit</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> type<span class="token punctuation">,</span> CKA_ENCRYPT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * DecryptInit */</span> PK11Context <span class="token operator">*</span> <span class="token function">DecryptInit</span><span class="token punctuation">(</span>PK11SymKey <span class="token operator">*</span>dk<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span> CK_MECHANISM_TYPE type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">CryptInit</span><span class="token punctuation">(</span>dk<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> type<span class="token punctuation">,</span> CKA_DECRYPT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Read cryptographic parameters from the header file */</span> SECStatus <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fileName<span class="token punctuation">,</span> HeaderType type<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>item<span class="token punctuation">,</span> PRBool isHexData<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PRFileDesc<span class="token operator">*</span> file<span class="token punctuation">;</span> SECItem filedata<span class="token punctuation">;</span> SECItem outbuf<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>nonbody<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>body<span class="token punctuation">;</span> <span class="token keyword">char</span> header<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">char</span> trailer<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> outbuf<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span> file <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed to open %s\n"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> SYMKEY<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> ENCKEY_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> ENCKEY_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MACKEY<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> MACKEY_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> MACKEY_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> IV<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> IV_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> IV_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> MAC<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> MAC_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> MAC_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> PAD<span class="token operator">:</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> PAD_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> PAD_TRAILER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">FileToItem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filedata<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span> nonbody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nonbody<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"unable to read data from input file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* check for headers and trailers and remove them */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>body <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>nonbody<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">char</span> <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> nonbody <span class="token operator">=</span> body<span class="token punctuation">;</span> body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">)</span> body <span class="token operator">=</span> <span class="token function">PORT_Strchr</span><span class="token punctuation">(</span>nonbody<span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* maybe this is a MAC file */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> trail <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token operator">++</span>body<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>trail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>trail <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"input has header but no trailer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PORT_Free</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> body <span class="token operator">=</span> nonbody<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">HexToBuf</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> item<span class="token punctuation">,</span> isHexData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECSuccess<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * EncryptAndMac */</span> SECStatus <span class="token function">EncryptAndMac</span><span class="token punctuation">(</span>PRFileDesc <span class="token operator">*</span>inFile<span class="token punctuation">,</span> PRFileDesc <span class="token operator">*</span>headerFile<span class="token punctuation">,</span> PRFileDesc <span class="token operator">*</span>encFile<span class="token punctuation">,</span> PK11SymKey <span class="token operator">*</span>ek<span class="token punctuation">,</span> PK11SymKey <span class="token operator">*</span>mk<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ptext<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ptextLen<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> mac<span class="token punctuation">[</span>DIGESTSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> macLen<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nwritten<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> encbuf<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> encbufLen<span class="token punctuation">;</span> SECItem noParams <span class="token operator">=</span> <span class="token punctuation">{</span> siBuffer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> PK11Context <span class="token operator">*</span>ctxmac <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PK11Context <span class="token operator">*</span>ctxenc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> SECItem padItem<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> paddingLength<span class="token punctuation">;</span> <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> firstTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> ctxmac <span class="token operator">=</span> <span class="token function">PK11_CreateContextBySymKey</span><span class="token punctuation">(</span>CKM_MD5_HMAC<span class="token punctuation">,</span> CKA_SIGN<span class="token punctuation">,</span> mk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>noParams<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't create MAC context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">MacInit</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> ctxenc <span class="token operator">=</span> <span class="token function">EncryptInit</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> CKM_AES_CBC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* read a buffer of plaintext from input file */</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptextLen <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ptext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Encrypt using it using CBC, using previously created IV */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptextLen <span class="token operator">!=</span> BLOCKSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span> paddingLength <span class="token operator">=</span> BLOCKSIZE <span class="token operator">-</span> ptextLen<span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token punctuation">(</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> paddingLength<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ptext<span class="token punctuation">[</span>ptextLen<span class="token operator">+</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>paddingLength<span class="token punctuation">;</span> <span class="token punctuation">}</span> ptextLen <span class="token operator">=</span> BLOCKSIZE<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">Encrypt</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span> encbuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encbufLen<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>encbuf<span class="token punctuation">)</span><span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> ptextLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Encrypt Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* save the last block of ciphertext as the next IV */</span> iv <span class="token operator">=</span> encbuf<span class="token punctuation">;</span> ivLen <span class="token operator">=</span> encbufLen<span class="token punctuation">;</span> <span class="token comment">/* write the cipher text to intermediate file */</span> nwritten <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>encFile<span class="token punctuation">,</span> encbuf<span class="token punctuation">,</span> encbufLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*PR_Assert(nwritten == encbufLen);*/</span> rv <span class="token operator">=</span> <span class="token function">MacUpdate</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> ptext<span class="token punctuation">,</span> ptextLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">MacFinal</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> mac<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macLen<span class="token punctuation">,</span> DIGESTSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"MacFinal Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>macLen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Bad MAC length\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>mac<span class="token punctuation">,</span> macLen<span class="token punctuation">,</span> MAC<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Write MAC Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> pad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> paddingLength<span class="token punctuation">;</span> padItem<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span> padItem<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pad<span class="token punctuation">;</span> padItem<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>padItem<span class="token punctuation">.</span>data<span class="token punctuation">,</span> padItem<span class="token punctuation">.</span>len<span class="token punctuation">,</span> PAD<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Write PAD Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxenc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Find the Key for the given mechanism */</span> PK11SymKey<span class="token operator">*</span> <span class="token function">FindKey</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> CK_MECHANISM_TYPE mechanism<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>keyBuf<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PK11SymKey <span class="token operator">*</span>key<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PK11_NeedLogin</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not authenticate to token %s.\n"</span><span class="token punctuation">,</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSlot</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> key <span class="token operator">=</span> <span class="token function">PK11_FindFixedKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> mechanism<span class="token punctuation">,</span> keyBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"PK11_FindFixedKey failed (err %d)\n"</span><span class="token punctuation">,</span> <span class="token function">PR_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PK11_FreeSlot</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> key<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Decrypt and Verify MAC */</span> SECStatus <span class="token function">DecryptAndVerifyMac</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> outFileName<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>cItem<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>macItem<span class="token punctuation">,</span> PK11SymKey<span class="token operator">*</span> ek<span class="token punctuation">,</span> PK11SymKey<span class="token operator">*</span> mk<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>ivItem<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>padItem<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> PRFileDesc<span class="token operator">*</span> inFile<span class="token punctuation">;</span> PRFileDesc<span class="token operator">*</span> outFile<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> decbuf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> decbufLen<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ptext<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ptextLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ctext<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ctextLen<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> newmac<span class="token punctuation">[</span>DIGESTSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> newmacLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> newptextLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> blockNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> SECItem noParams <span class="token operator">=</span> <span class="token punctuation">{</span> siBuffer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> PK11Context <span class="token operator">*</span>ctxmac <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PK11Context <span class="token operator">*</span>ctxenc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> iv<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ivLen <span class="token operator">=</span> ivItem<span class="token operator">-&gt;</span>len<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> fileLength<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> paddingLength<span class="token punctuation">;</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token function">memcpy</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> ivItem<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> ivItem<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> paddingLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>padItem<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ctxmac <span class="token operator">=</span> <span class="token function">PK11_CreateContextBySymKey</span><span class="token punctuation">(</span>CKM_MD5_HMAC<span class="token punctuation">,</span> CKA_SIGN<span class="token punctuation">,</span> mk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>noParams<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't create MAC context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the input file. */</span> inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> PR_RDONLY <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the output file. */</span> outFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>outFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR <span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> outFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">MacInit</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> ctxenc <span class="token operator">=</span> <span class="token function">DecryptInit</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> ivLen<span class="token punctuation">,</span> CKM_AES_CBC<span class="token punctuation">)</span><span class="token punctuation">;</span> fileLength <span class="token operator">=</span> <span class="token function">FileSize</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ctextLen <span class="token operator">=</span> <span class="token function">PR_Read</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> ctext<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ctext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> count <span class="token operator">+=</span> ctextLen<span class="token punctuation">;</span> <span class="token comment">/* decrypt cipher text buffer using CBC and IV */</span> rv <span class="token operator">=</span> <span class="token function">Decrypt</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span> decbuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>decbufLen<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>decbuf<span class="token punctuation">)</span><span class="token punctuation">,</span> ctext<span class="token punctuation">,</span> ctextLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Decrypt Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>decbufLen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">MacUpdate</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> decbuf<span class="token punctuation">,</span> decbufLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> fileLength<span class="token punctuation">)</span> <span class="token punctuation">{</span> decbufLen <span class="token operator">=</span> decbufLen<span class="token operator">-</span>paddingLength<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* write the plain text to out file */</span> temp <span class="token operator">=</span> <span class="token function">PR_Write</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> decbuf<span class="token punctuation">,</span> decbufLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">!=</span> decbufLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"write error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* save last block of ciphertext */</span> <span class="token function">memcpy</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> decbuf<span class="token punctuation">,</span> decbufLen<span class="token punctuation">)</span><span class="token punctuation">;</span> ivLen <span class="token operator">=</span> decbufLen<span class="token punctuation">;</span> blockNumber<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">MacFinal</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> newmac<span class="token punctuation">,</span> <span class="token operator">&amp;</span>newmacLen<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newmac<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PORT_Memcmp</span><span class="token punctuation">(</span>macItem<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> newmac<span class="token punctuation">,</span> newmacLen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECSuccess<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Check MAC : Failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Extracted : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PrintAsHex</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> macItem<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> macItem<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Computed : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PrintAsHex</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> newmac<span class="token punctuation">,</span> newmacLen<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxmac<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxmac<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctxenc<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_DestroyContext</span><span class="token punctuation">(</span>ctxenc<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * Gets IV and CKAIDS From Header File */</span> SECStatus <span class="token function">GetIVandCKAIDSFromHeader</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cipherFileName<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>ivItem<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>encKeyItem<span class="token punctuation">,</span> SECItem <span class="token operator">*</span>macKeyItem<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> <span class="token comment">/* open intermediate file, read in header, get IV and CKA_IDs of two keys * from it */</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>cipherFileName<span class="token punctuation">,</span> IV<span class="token punctuation">,</span> ivItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not retrieve IV from cipher file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>cipherFileName<span class="token punctuation">,</span> SYMKEY<span class="token punctuation">,</span> encKeyItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not retrieve AES CKA_ID from cipher file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>cipherFileName<span class="token punctuation">,</span> MACKEY<span class="token punctuation">,</span> macKeyItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not retrieve MAC CKA_ID from cipher file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * DecryptFile */</span> SECStatus <span class="token function">DecryptFile</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>outFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* * The DB is open read only and we have authenticated to it * open input file, read in header, get IV and CKA_IDs of two keys from it * find those keys in the DB token * Open output file * loop until EOF(input): * read a buffer of ciphertext from input file, * Save last block of ciphertext * decrypt ciphertext buffer using CBC and IV, * compute and check MAC, then remove MAC from plaintext * replace IV with saved last block of ciphertext * write the plain text to output file * close files * report success */</span> SECStatus rv<span class="token punctuation">;</span> SECItem ivItem<span class="token punctuation">;</span> SECItem encKeyItem<span class="token punctuation">;</span> SECItem macKeyItem<span class="token punctuation">;</span> SECItem cipherItem<span class="token punctuation">;</span> SECItem macItem<span class="token punctuation">;</span> SECItem padItem<span class="token punctuation">;</span> PK11SymKey <span class="token operator">*</span>encKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PK11SymKey <span class="token operator">*</span>macKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* open intermediate file, read in header, get IV and CKA_IDs of two keys * from it */</span> rv <span class="token operator">=</span> <span class="token function">GetIVandCKAIDSFromHeader</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ivItem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encKeyItem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macKeyItem<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* find those keys in the DB token */</span> encKey <span class="token operator">=</span> <span class="token function">FindKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> CKM_AES_CBC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encKeyItem<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't find the encryption key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* CKM_MD5_HMAC or CKM_EXTRACT_KEY_FROM_KEY */</span> macKey <span class="token operator">=</span> <span class="token function">FindKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> CKM_MD5_HMAC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macKeyItem<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Read in the Mac into item from the intermediate file */</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> MAC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not retrieve MAC from cipher file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>macItem<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"MAC has NULL data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>macItem<span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"MAC has data has 0 length\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*rv = SECFailure; goto cleanup;*/</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">ReadFromHeaderFile</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PAD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>padItem<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not retrieve PAD detail from header file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">==</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Decrypt and Remove Mac */</span> rv <span class="token operator">=</span> <span class="token function">DecryptAndVerifyMac</span><span class="token punctuation">(</span>outFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cipherItem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macItem<span class="token punctuation">,</span> encKey<span class="token punctuation">,</span> macKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ivItem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>padItem<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed while decrypting and removing MAC\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSlot</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>encKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>macKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * EncryptFile */</span> SECStatus <span class="token function">EncryptFile</span><span class="token punctuation">(</span>PK11SlotInfo <span class="token operator">*</span>slot<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>headerFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>encryptedFileName<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>noiseFileName<span class="token punctuation">,</span> secuPWData <span class="token operator">*</span>pwdata<span class="token punctuation">,</span> PRBool ascii<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* * The DB is open for read/write and we have authenticated to it. * generate a symmetric AES key as a token object. * generate a second key to use for MACing, also a token object. * get their CKA_IDs * generate a random value to use as IV for AES CBC * open an input file and an output file, * write a header to the output that identifies the two keys by * their CKA_IDs, May include original file name and length. * loop until EOF(input) * read a buffer of plaintext from input file, * MAC it, append the MAC to the plaintext * encrypt it using CBC, using previously created IV, * store the last block of ciphertext as the new IV, * write the cipher text to intermediate file * close files * report success */</span> SECStatus rv<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>inFile<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>headerFile<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>encFile<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>encKeyId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"Encrypt Key"</span><span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>macKeyId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"MAC Key"</span><span class="token punctuation">;</span> SECItem encKeyID <span class="token operator">=</span> <span class="token punctuation">{</span> siAsciiString<span class="token punctuation">,</span> encKeyId<span class="token punctuation">,</span> <span class="token function">PL_strlen</span><span class="token punctuation">(</span>encKeyId<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> SECItem macKeyID <span class="token operator">=</span> <span class="token punctuation">{</span> siAsciiString<span class="token punctuation">,</span> macKeyId<span class="token punctuation">,</span> <span class="token function">PL_strlen</span><span class="token punctuation">(</span>macKeyId<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> SECItem encCKAID<span class="token punctuation">;</span> SECItem macCKAID<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> iv<span class="token punctuation">[</span>BLOCKSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> SECItem ivItem<span class="token punctuation">;</span> PK11SymKey <span class="token operator">*</span>encKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PK11SymKey <span class="token operator">*</span>macKey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> SECItem temp<span class="token punctuation">;</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> c<span class="token punctuation">;</span> <span class="token comment">/* generate a symmetric AES key as a token object. */</span> encKey <span class="token operator">=</span> <span class="token function">GenerateSYMKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> CKM_AES_KEY_GEN<span class="token punctuation">,</span> <span class="token number">128</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>encKeyID<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"GenerateSYMKey for AES returned NULL.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* generate a second key to use for MACing, also a token object. */</span> macKey <span class="token operator">=</span> <span class="token function">GenerateSYMKey</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> CKM_GENERIC_SECRET_KEY_GEN<span class="token punctuation">,</span> <span class="token number">160</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>macKeyID<span class="token punctuation">,</span> pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"GenerateSYMKey for MACing returned NULL.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* get the encrypt key CKA_ID */</span> rv <span class="token operator">=</span> <span class="token function">GatherCKA_ID</span><span class="token punctuation">(</span>encKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encCKAID<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error while wrapping encrypt key\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* get the MAC key CKA_ID */</span> rv <span class="token operator">=</span> <span class="token function">GatherCKA_ID</span><span class="token punctuation">(</span>macKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>macCKAID<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Can't get the MAC key CKA_ID.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>noiseFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">SeedFromNoiseFile</span><span class="token punctuation">(</span>noiseFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PORT_SetError</span><span class="token punctuation">(</span>PR_END_OF_FILE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">PK11_GenerateRandom</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">/* generate a random value to use as IV for AES CBC */</span> <span class="token function">GenerateRandom</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> headerFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> encFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> PR_CREATE_FILE <span class="token operator">|</span> PR_TRUNCATE <span class="token operator">|</span> PR_RDWR<span class="token punctuation">,</span> <span class="token number">00660</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for writing.\n"</span><span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* write to a header file the IV and the CKA_IDs * identifying the two keys */</span> ivItem<span class="token punctuation">.</span>type <span class="token operator">=</span> siBuffer<span class="token punctuation">;</span> ivItem<span class="token punctuation">.</span>data <span class="token operator">=</span> iv<span class="token punctuation">;</span> ivItem<span class="token punctuation">.</span>len <span class="token operator">=</span> BLOCKSIZE<span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> BLOCKSIZE<span class="token punctuation">,</span> IV<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error writing IV to cipher file - %s\n"</span><span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>encCKAID<span class="token punctuation">.</span>data<span class="token punctuation">,</span> encCKAID<span class="token punctuation">.</span>len<span class="token punctuation">,</span> SYMKEY<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error writing AES CKA_ID to cipher file - %s\n"</span><span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">WriteToHeaderFile</span><span class="token punctuation">(</span>macCKAID<span class="token punctuation">.</span>data<span class="token punctuation">,</span> macCKAID<span class="token punctuation">.</span>len<span class="token punctuation">,</span> MACKEY<span class="token punctuation">,</span> headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Error writing MAC CKA_ID to cipher file - %s\n"</span><span class="token punctuation">,</span> headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open the input file. */</span> inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Macing and Encryption */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">==</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">EncryptAndMac</span><span class="token punctuation">(</span>inFile<span class="token punctuation">,</span> headerFile<span class="token punctuation">,</span> encFile<span class="token punctuation">,</span> encKey<span class="token punctuation">,</span> macKey<span class="token punctuation">,</span> ivItem<span class="token punctuation">.</span>data<span class="token punctuation">,</span> ivItem<span class="token punctuation">.</span>len<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed : Macing and Encryption\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>inFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>headerFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>encFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSlot</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encKey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>encKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>macKey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PK11_FreeSymKey</span><span class="token punctuation">(</span>macKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* * This example illustrates basic encryption/decryption and MACing * Generates the encryption/mac keys and uses token for storing. * Encrypts the input file and appends MAC before storing in intermediate * header file. * Writes the CKA_IDs of the encryption keys into intermediate header file. * Reads the intermediate headerfile for CKA_IDs and encrypted * contents and decrypts into output file. */</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span> SECStatus rv<span class="token punctuation">;</span> SECStatus rvShutdown<span class="token punctuation">;</span> PK11SlotInfo <span class="token operator">*</span>slot <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> PLOptState <span class="token operator">*</span>optstate<span class="token punctuation">;</span> PLOptStatus status<span class="token punctuation">;</span> <span class="token keyword">char</span> headerFileName<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">char</span> encryptedFileName<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>inFile<span class="token punctuation">;</span> PRFileDesc <span class="token operator">*</span>outFile<span class="token punctuation">;</span> PRBool ascii <span class="token operator">=</span> PR_FALSE<span class="token punctuation">;</span> CommandType cmd <span class="token operator">=</span> UNKNOWN<span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dbdir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>outFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>noiseFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> secuPWData pwdata <span class="token operator">=</span> <span class="token punctuation">{</span> PW_NONE<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span> progName <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> progName <span class="token operator">=</span> progName <span class="token operator">?</span> progName <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Parse command line arguments */</span> optstate <span class="token operator">=</span> <span class="token function">PL_CreateOptState</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"c:d:i:o:f:p:z:a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">PL_GetNextOpt</span><span class="token punctuation">(</span>optstate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> PL_OPT_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>option<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token string">'a'</span><span class="token operator">:</span> ascii <span class="token operator">=</span> PR_TRUE<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'c'</span><span class="token operator">:</span> command <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'d'</span><span class="token operator">:</span> dbdir <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'f'</span><span class="token operator">:</span> pwdata<span class="token punctuation">.</span>source <span class="token operator">=</span> PW_FROMFILE<span class="token punctuation">;</span> pwdata<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'p'</span><span class="token operator">:</span> pwdata<span class="token punctuation">.</span>source <span class="token operator">=</span> PW_PLAINTEXT<span class="token punctuation">;</span> pwdata<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'i'</span><span class="token operator">:</span> inFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'o'</span><span class="token operator">:</span> outFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token string">'z'</span><span class="token operator">:</span> noiseFileName <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>optstate<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token function">PL_DestroyOptState</span><span class="token punctuation">(</span>optstate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">||</span> <span class="token operator">!</span>dbdir <span class="token operator">||</span> <span class="token operator">!</span>inFileName <span class="token operator">||</span> <span class="token operator">!</span>outFileName<span class="token punctuation">)</span> <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PL_strlen</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">Usage</span><span class="token punctuation">(</span>progName<span class="token punctuation">)</span><span class="token punctuation">;</span> cmd <span class="token operator">=</span> command<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'a'</span> <span class="token operator">?</span> ENCRYPT <span class="token operator">:</span> command<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'b'</span> <span class="token operator">?</span> DECRYPT <span class="token operator">:</span> UNKNOWN<span class="token punctuation">;</span> <span class="token comment">/* Open the input file. */</span> inFile <span class="token operator">=</span> <span class="token function">PR_Open</span><span class="token punctuation">(</span>inFileName<span class="token punctuation">,</span> PR_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inFile<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Unable to open \"%s\" for reading.\n"</span><span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PR_Close</span><span class="token punctuation">(</span>inFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* For intermediate header file, choose filename as inputfile name with extension ".header" */</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcat</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> <span class="token string">".header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* For intermediate encrypted file, choose filename as inputfile name with extension ".enc" */</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> inFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">strcat</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> <span class="token string">".enc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">PR_Init</span><span class="token punctuation">(</span>PR_USER_THREAD<span class="token punctuation">,</span> PR_PRIORITY_NORMAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> ENCRYPT<span class="token operator">:</span> <span class="token comment">/* If the intermediate header file already exists, delete it */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PR_Access</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">,</span> PR_ACCESS_EXISTS<span class="token punctuation">)</span> <span class="token operator">==</span> PR_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Delete</span><span class="token punctuation">(</span>headerFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* If the intermediate encrypted already exists, delete it */</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PR_Access</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">,</span> PR_ACCESS_EXISTS<span class="token punctuation">)</span> <span class="token operator">==</span> PR_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_Delete</span><span class="token punctuation">(</span>encryptedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Open DB for read/write and authenticate to it. */</span> rv <span class="token operator">=</span> <span class="token function">NSS_InitReadWrite</span><span class="token punctuation">(</span>dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"NSS_InitReadWrite Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PK11_SetPasswordFunc</span><span class="token punctuation">(</span>GetModulePassword<span class="token punctuation">)</span><span class="token punctuation">;</span> slot <span class="token operator">=</span> <span class="token function">PK11_GetInternalKeySlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PK11_NeedLogin</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not authenticate to token %s.\n"</span><span class="token punctuation">,</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">EncryptFile</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> inFileName<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">,</span> noiseFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"EncryptFile : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token keyword">case</span> DECRYPT<span class="token operator">:</span> <span class="token comment">/* Open DB read only, authenticate to it */</span> <span class="token function">PK11_SetPasswordFunc</span><span class="token punctuation">(</span>GetModulePassword<span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> <span class="token function">NSS_Init</span><span class="token punctuation">(</span>dbdir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"NSS_Init Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> slot <span class="token operator">=</span> <span class="token function">PK11_GetInternalKeySlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PK11_NeedLogin</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> rv <span class="token operator">=</span> <span class="token function">PK11_Authenticate</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> PR_TRUE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Could not authenticate to token %s.\n"</span><span class="token punctuation">,</span> <span class="token function">PK11_GetTokenName</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> rv <span class="token operator">=</span> <span class="token function">DecryptFile</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> dbdir<span class="token punctuation">,</span> outFileName<span class="token punctuation">,</span> headerFileName<span class="token punctuation">,</span> encryptedFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwdata<span class="token punctuation">,</span> ascii<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"DecryptFile : Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> cleanup<span class="token operator">:</span> rvShutdown <span class="token operator">=</span> <span class="token function">NSS_Shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rvShutdown <span class="token operator">!=</span> SECSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">PR_fprintf</span><span class="token punctuation">(</span>PR_STDERR<span class="token punctuation">,</span> <span class="token string">"Failed : NSS_Shutdown()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rv <span class="token operator">=</span> SECFailure<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token function">PR_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> rv<span class="token punctuation">;</span> <span class="token punctuation">}</span>

</code></pre></div>